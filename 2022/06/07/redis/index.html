

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#447EA5">
  <meta name="author" content="zlw">
  <meta name="keywords" content="">
  
    <meta name="description" content="NoSQL数据库简介主要解决性能问题 Web1.0 的时代，数据访问量很有限，用一夫当关的高性能的单点服务器可以解决大部分问题。   随着 Web2.0 的时代的到来，用户访问量大幅度提升，同时产生了大量的用户数据。加上后来的智能移动设备的普及，所有的互联网平台都面临了巨大的性能挑战。    NoSQL的出现解决了解决 CPU 及内存压力  和 IO 压力   解决 CPU 及内存压力将服务器进行">
<meta property="og:type" content="article">
<meta property="og:title" content="redis">
<meta property="og:url" content="http://example.com/2022/06/07/redis/index.html">
<meta property="og:site_name" content="zlw">
<meta property="og:description" content="NoSQL数据库简介主要解决性能问题 Web1.0 的时代，数据访问量很有限，用一夫当关的高性能的单点服务器可以解决大部分问题。   随着 Web2.0 的时代的到来，用户访问量大幅度提升，同时产生了大量的用户数据。加上后来的智能移动设备的普及，所有的互联网平台都面临了巨大的性能挑战。    NoSQL的出现解决了解决 CPU 及内存压力  和 IO 压力   解决 CPU 及内存压力将服务器进行">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220607112049192.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220607112137349.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220607124939134.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220607125734946.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220607131718774.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220607131847688.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220607133051004.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220607134236942.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220607151814346.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220607155709655.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220607161721235.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220607221305094.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220607221433147.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220608094714290.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220608100244411.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220608100603141.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220608101336433.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220608101808071.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220608101833339.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220608101952307.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220608103326649.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220608103423389.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220608103630010.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220608104301235.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220608104401677.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220608104503203.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220608104720055.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220608114625329.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220608134027626.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220608133540388.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220608134454960.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220608135235012.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220608140213830.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220608140726491.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220609132109343.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220609132539677.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220609193324763.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220609160158010.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220609163844921.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220609163802517.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220609163732378.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220609193655926.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610102855173.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610102915397.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610104030188.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610111351081.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610113123157.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610111839270.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610115550445.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610115726460.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610121734297.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610121748075.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610124129675.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610131018008.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610130004189.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610130140398.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610130257347.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610132151742.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610143457717.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610144458611.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610144742863.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610145205724.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610150150521.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610150026377.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610152715911.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610152828761.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610152957380.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610153011261.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610153713549.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610154032749.png">
<meta property="og:image" content="http://example.com/2022/06/07/redis/image-20220610154103532.png">
<meta property="article:published_time" content="2022-06-07T03:18:02.000Z">
<meta property="article:modified_time" content="2022-08-29T03:35:51.198Z">
<meta property="article:author" content="zlw">
<meta property="article:tag" content="redis">
<meta property="article:tag" content="NoSQL">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2022/06/07/redis/image-20220607112049192.png">
  
  
  
  <title>redis - zlw</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/diy/shubiao.css">
<link rel="stylesheet" href="/css/mac.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/xiantiao.js.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/shubiao.css# 鼠标指针.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.0","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"8pDDCsRJCVNm1OXHuh0xASVj-gzGzoHsz","app_key":"MnpSoeG5QTTJ4GagUMOq5t7J","server_url":"https://leancloud.cn","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>

  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>欢迎来到张露文的Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/2.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="redis"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-06-07 11:18" pubdate>
          2022年6月7日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          38k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          319 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">redis</h1>
            
            <div class="markdown-body">
              
              <h1 id="NoSQL数据库简介"><a href="#NoSQL数据库简介" class="headerlink" title="NoSQL数据库简介"></a>NoSQL数据库简介</h1><p><strong>主要解决性能问题</strong></p>
<p>Web1.0 的时代，数据访问量很有限，用一夫当关的高性能的单点服务器可以解决大部分问题。  </p>
<p>随着 Web2.0 的时代的到来，用户访问量大幅度提升，同时产生了大量的用户数据。加上后来的智能移动设备的普及，所有的互联网平台都面临了巨大的性能挑战。  </p>
<p><img src="/2022/06/07/redis/image-20220607112049192.png" srcset="/img/loading.gif" lazyload alt="image-20220607112049192"></p>
<p><strong>NoSQL的出现解决了解决 CPU 及内存压力  和 IO 压力</strong>  </p>
<h2 id="解决-CPU-及内存压力"><a href="#解决-CPU-及内存压力" class="headerlink" title="解决 CPU 及内存压力"></a>解决 CPU 及内存压力</h2><p>将服务器进行 集群 或 分布式 部署，也就是多台服务器。通过nginx（负载均衡）进行分配服务器。</p>
<p>但存在一个问题，就是当用户访问服务器时，例如，分配了第一个服务器，将session存储到服务器1中，但当第二次访问时，分配的是第二台服务器，此时第二台服务器没有session对象，怎么办？</p>
<p><img src="/2022/06/07/redis/image-20220607112137349.png" srcset="/img/loading.gif" lazyload alt="image-20220607112137349"></p>
<p><strong>NoSql可以减少cpu和io的压力，直接通过内存进行读取，nosql可以缓存数据库，提高访问速度，减少io操作</strong>  </p>
<h2 id="解决-IO-压力"><a href="#解决-IO-压力" class="headerlink" title="解决 IO 压力"></a>解决 IO 压力</h2><p><img src="/2022/06/07/redis/image-20220607124939134.png" srcset="/img/loading.gif" lazyload alt="image-20220607124939134"></p>
<h2 id="NoSQL-数据库概述"><a href="#NoSQL-数据库概述" class="headerlink" title="NoSQL 数据库概述"></a>NoSQL 数据库概述</h2><p><strong>非关系型的数据库</strong>  。NoSQL 不依赖业务逻辑方式存储，而以简单的 key-value 模式存储。因此大大的增加了数据库的扩展能力。  </p>
<ul>
<li>不遵循 SQL 标准。</li>
<li>不支持 ACID。（原子性，一致性，隔离性，持久性  ）</li>
<li>远超于 SQL 的性能。</li>
</ul>
<p><strong>NoSQL 适用场景</strong>  </p>
<ul>
<li>数据高并发的读写</li>
<li>海量数据的读写</li>
<li>对数据高可扩展性的</li>
</ul>
<p><strong>NoSQL 不适用场景</strong>  </p>
<ul>
<li>需要事务支持</li>
<li>基于 sql 的结构化查询存储，处理复杂的关系,需要即席查询。</li>
<li><strong>（用不着 sql 的和用了 sql 也不行的情况，请考虑用 NoSql）</strong></li>
</ul>
<p><strong>NoSQL具体的数据库：</strong></p>
<p>（1）Memcache</p>
<ul>
<li>很早出现的 NoSql 数据库</li>
<li>数据都在内存中， 一般不持久化</li>
<li>支持简单的 key-value 模式， 支持类型单一 </li>
<li>一般是作为缓存数据库辅助持久化的数据库</li>
</ul>
<p><strong>（2） Redis</strong></p>
<ul>
<li>几乎覆盖了 Memcached 的绝大部分功能 </li>
<li>数据都在内存中， 支持持久化， 主要用作备份恢复</li>
<li>除了支持简单的 key-value 模式， 还支持多种数据结构 的存储， 比如 list、 set、 hash、 zset 等。</li>
<li>一般是作为缓存数据库辅助持久化的数据库</li>
</ul>
<p>（3） MongoDB</p>
<ul>
<li>数据都在内存中， 如果内存不足， 把不常用的数据保 存到硬盘 </li>
<li>虽 然 是 key-value 模 式 ， 但 是 对 value （ 尤 其 是 json） 提供了丰富的查询功能  支持二进制数据及大型对象 </li>
<li>可以根据数据的特点替代 RDBMS ， 成为独立的数据 库。 或者配合 RDBMS， 存储特定的数据。</li>
</ul>
<h1 id="Redis安装"><a href="#Redis安装" class="headerlink" title="Redis安装"></a>Redis安装</h1><p>（1）在官网下载稳定版本</p>
<p>（2）<strong>在linux环境下进行安装</strong>，eg：redis-6.2.1.tar.gz  </p>
<p>（3）在linux环境 <strong>安装 C 语言的编译环境</strong>  </p>
<ul>
<li><code>yum install centos-release-scl scl-utils-build</code>  </li>
<li><code>yum install -y devtoolset-8-toolchain</code>  </li>
<li><code>scl enable devtoolset-8 bash</code></li>
</ul>
<p><strong>如果在Centos7下，直接安装gcc就可以</strong>  ：<code>yum install gcc</code></p>
<p>测试gcc版本 ： <code>gcc --version</code>  (GCC是一个用于linux系统下编程的编译器)</p>
<p><img src="/2022/06/07/redis/image-20220607125734946.png" srcset="/img/loading.gif" lazyload alt="image-20220607125734946"></p>
<p>（4）<strong>下载 <code>redis-6.2.1.tar.gz</code> 放&#x2F;opt&#x2F;redis 目录  中（</strong>运用文件传输软件，例如Xftp）</p>
<p>（5）<strong>解压命令</strong>： <code>tar -zxvf redis-6.2.1.tar.gz</code>  </p>
<p>（6）<strong>解压完成后进入目录</strong>： cd redis-6.2.1  </p>
<p>（7）在 redis-6.2.1 目录下<strong>执行 <code>make</code> 命令</strong>  </p>
<p>（8）如果没有准备好 C 语言编译环境， <code>make</code> 会报错—<code>Jemalloc/jemalloc.h</code>： 没有那个文件  </p>
<ul>
<li>解决方案： 运行 <code>make distclean</code>  后再次执行<code>make</code>。</li>
</ul>
<p>（9）跳过 make test 继续执行: <strong><code>make install</code></strong>  </p>
<p>（10）<strong>默认的安装目录为</strong>：<code>/usr/local/bin</code>  </p>
<p>查看默认安装目录：  </p>
<ul>
<li><code>redis-benchmark</code>:性能测试工具，可以在自己本子运行，看看自己本子性能如何  </li>
<li><code>redis-check-aof</code>：修复有问题的 AOF 文件，rdb 和 aof 后面讲  </li>
<li><code>redis-check-dump</code>：修复有问题的 dump.rdb 文件  </li>
<li><code>redis-sentinel</code>：Redis 集群使用  </li>
<li><code>redis-server</code>：Redis 服务器启动命令  </li>
<li><code>redis-cli</code>：客户端，操作入口</li>
</ul>
<p>（11）<strong>后台启动</strong></p>
<ul>
<li>备份redis.conf     ：  <code>cp /opt/redis-3.2.5/redis.conf  /etc/ redis.conf</code></li>
</ul>
<p>（12）<strong>后台启动设置 daemonize no 改成 yes</strong>  ：修改 redis.conf(128 行)文件将里面的 daemonize no 改成 yes，让服务在后台启动  </p>
<p>（13）<strong>Redis 启动</strong>  ：  <code>redis-server /etc/redis.conf</code>  </p>
<p>（14）<strong>用客户端访问：</strong> <code>redis-cli</code>  </p>
<p>（15）<strong>测试验证：</strong> ping  </p>
<p><img src="/2022/06/07/redis/image-20220607131718774.png" srcset="/img/loading.gif" lazyload alt="image-20220607131718774"></p>
<p>（16）<strong>Redis 关闭：</strong>  </p>
<ul>
<li>单实例关闭：redis-cli shutdown  </li>
<li>也可以通过关闭进程进行关闭</li>
</ul>
<p><img src="/2022/06/07/redis/image-20220607131847688.png" srcset="/img/loading.gif" lazyload alt="image-20220607131847688"></p>
<p><strong>(17)给redis设置密码：</strong></p>
<p>修改redis.conf配置文件中的requirepass，修改为如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"># requirepass foobared<br>requirepass Zlw199805<br></code></pre></td></tr></table></figure>



<h1 id="Redis-介绍相关知识"><a href="#Redis-介绍相关知识" class="headerlink" title="Redis 介绍相关知识"></a>Redis 介绍相关知识</h1><p><strong>redis的底层使用的是：单线程+多路IO服用 ：</strong></p>
<p>Redis支持多线程主要有两个原因：</p>
<ul>
<li>可以充分利用服务器CPU资源，目前主线程只能利用一个核。</li>
<li>多线程任务可以分摊Redis同步IO读写负荷。</li>
</ul>
<p><img src="/2022/06/07/redis/image-20220607133051004.png" srcset="/img/loading.gif" lazyload alt="image-20220607133051004"></p>
<p>黄牛还没有买到票的时候，123个人都在做自己的事情，而不是一直等待着票。</p>
<h1 id="Redis中常用的五大数据类型"><a href="#Redis中常用的五大数据类型" class="headerlink" title="Redis中常用的五大数据类型"></a>Redis中常用的五大数据类型</h1><h2 id="Redis键（Key）"><a href="#Redis键（Key）" class="headerlink" title="Redis键（Key）"></a>Redis键（Key）</h2><p>（1）<code>keys *</code> ：查看当前库中所有的key</p>
<p><img src="/2022/06/07/redis/image-20220607134236942.png" srcset="/img/loading.gif" lazyload alt="image-20220607134236942"></p>
<p>（2）<code>exists key</code>  ：判断某个 key 是否存在  </p>
<p>（3）<code>type key</code>：查看你的 key 是什么类型  </p>
<p>（4）<code>del key</code> ：删除指定的 key 数据   &#x2F;  unlink key 根据 value 选择非阻塞删除  </p>
<p>（5）<code>expire key 10</code> ：10 秒钟：为给定的 key 设置过期时间  </p>
<p>（6）<code>ttl key</code> ：查看还有多少秒过期，-1 表示永不过期，-2 表示已过期  </p>
<p>（7）<code>select</code> ：命令切换数据库  </p>
<p>（8）<code>dbsize</code> ：查看当前数据库的 key 的数量  </p>
<p>（9） <code>flushdb</code> ：清空当前库  &#x2F;   <code>flushall</code> ：通杀全部库  </p>
<h2 id="Redis-字符串-String"><a href="#Redis-字符串-String" class="headerlink" title="Redis 字符串(String)"></a>Redis 字符串(String)</h2><p><strong>String 类型是二进制安全的（内容能用字符串表示的  ）。意味着 Redis 的 string 可以包含任何数据。比如 jpg 图片或者序列化的对象。</strong>  </p>
<p><strong>String 类型是 Redis 最基本的数据类型，一个 Redis 中字符串 value 最多可以是 512M</strong>  </p>
<p><strong>常用命令</strong>  </p>
<p>（1）<code>set &lt;key&gt;&lt;value&gt;</code>：添加键值对(内容能用字符串表示的)如果设置相同的key，则前面的value被覆盖  </p>
<p>（2）<code>get &lt;key&gt;</code>：查询对应键值  </p>
<p>（3）<code>append &lt;key&gt;&lt;value&gt;</code>：将给定的<value> 追加到原值的末尾  </value></p>
<p>（4）<code>strlen &lt;key&gt;</code>：获得值的长度  </p>
<p>（5）<code>setnx &lt;key&gt;&lt;value&gt;</code>：只有在 key 不存在时 设置 key 的值</p>
<p>（6）<code>incr &lt;key&gt;</code>    ：将 key 中储存的数字值增 1  （只能对数字操作）</p>
<p>（7）<code>decr &lt;key&gt;</code>  ：将 key 中储存的数字值减 1  （只能对数字操作）</p>
<p>（8） <code>incrby / decrby &lt;key&gt;&lt;步长&gt;</code>：将 key 中储存的数字值增减。自定义步长。  </p>
<ul>
<li>是原子性的：<strong>所谓原子操作是指不会被线程调度机制打断的操作；</strong>  </li>
<li>（1）在单线程中， 能够在单条指令中完成的操作都可以认为是”原子操作”，因为中断只能发生于指令之间。</li>
<li>（2）在多线程中，不能被其它进程（线程）打断的操作就叫原子操作。</li>
<li>Redis 单命令的原子性主要得益于 Redis 的单线程。</li>
</ul>
<p>（9）<code>mset &lt;key1&gt;&lt;value1&gt;&lt;key2&gt;&lt;value2&gt; .....</code>同时设置一个或多个 key-value 对  </p>
<p>（10）<code>mget &lt;key1&gt;&lt;key2&gt;&lt;key3&gt; .....</code>同时获取一个或多个 value  </p>
<p>（11）<code>msetnx &lt;key1&gt;&lt;value1&gt;&lt;key2&gt;&lt;value2&gt; .....</code>  ：同时设置一个或多个 key-value 对，当且仅当所有给定 key 都不存在  </p>
<p>（12）<code>getrange &lt;key&gt;&lt;起始位置&gt;&lt;结束位置&gt;</code>： 获得值的范围  </p>
<p>（13）<code>setrange &lt;key&gt;&lt;起始位置&gt;&lt;value&gt;</code> ：用 <value> 覆写<key>所储存的字符串值，从&lt;起始位置&gt;开始(索引从 0 开始)。  </key></value></p>
<p>（14）<code>setex &lt;key&gt;&lt;过期时间&gt;&lt;value&gt;</code>：设置键值的同时，设置过期时间，单位秒  </p>
<p>（15）<code>getset &lt;key&gt;&lt;value&gt;</code>：以新换旧，设置了新值同时获得旧值。  </p>
<p><strong>数据结构：</strong></p>
<p>String 的数据结构为<strong>简单动态字符串</strong>(Simple Dynamic String,缩写 SDS)。是可以修改的字符串，内部结构实现上类似于 Java 的 ArrayList，采用预分配冗余空间的方式来减少内存的频繁分配.  </p>
<p><img src="/2022/06/07/redis/image-20220607151814346.png" srcset="/img/loading.gif" lazyload alt="image-20220607151814346"></p>
<p>内部为当前字符串实际分配的空间 capacity 一般要高于实际字符串长度len。如果字符串小于1M，扩容加倍现有的空间，如果超过1M，扩容时多扩1M空间。  需要注意的是字符串最大长度为 512M  。</p>
<h2 id="Redis-列表-List"><a href="#Redis-列表-List" class="headerlink" title="Redis 列表(List)"></a>Redis 列表(List)</h2><p><strong>单键多值  按照插入顺序排序。你可以添加一个元素到列表的头部（左边）或者尾部（右边）</strong>  <strong>它的底层实际是个双向链表，</strong>  </p>
<p><strong>常用命令</strong></p>
<p>（1）<code>lpush/rpush &lt;key&gt;&lt;value1&gt;&lt;value2&gt;&lt;value3&gt; ....</code>： 从左边&#x2F;右边插入一个或多个值。<br>（2）<code>lpop/rpop &lt;key&gt;</code>从左边&#x2F;右边吐出一个值。值在键在，值光键亡。<br>（3）<code>rpoplpush &lt;key1&gt;&lt;key2&gt;</code>从<key1>列表右边吐出一个值，插到<key2>列表左边。<br>（4）<code>lrange &lt;key&gt;&lt;start&gt;&lt;stop&gt;</code>按照索引下标获得元素(从左到右)<br>（5）<code>lrange mylist 0 -1 0</code> 左边第一个，-1 右边第一个，（0-1 表示获取所有）<br>（6）<code>lindex &lt;key&gt;&lt;index&gt;</code>按照索引下标获得元素(从左到右)<br>（7）<code>llen &lt;key&gt;</code>获得列表长度<br>（8）<code>linsert &lt;key&gt; before &lt;value&gt;&lt;newvalue&gt;</code>在<value>的后面插入<newvalue>插入值<br>（9）<code>lrem &lt;key&gt;&lt;n&gt;&lt;value&gt;</code>从左边删除 n 个 value(从左到右)<br>（10）<code>lset&lt;key&gt;&lt;index&gt;&lt;value&gt;</code>将列表 key 下标为 index 的值替换成 value  </newvalue></value></key2></key1></p>
<p><strong>数据结构</strong></p>
<p><strong>List 的数据结构为快速链表 quickList。</strong>  </p>
<p><strong>当列表元素比较少的情况下</strong>，会使用一块连续的内存存储，<strong>这个结构是 ziplist，也即是压缩列表</strong>  。因为普通的链表需要的附加指针空间太大，会比较浪费空间。  </p>
<p><strong>当数据量比较多的时候才会改成 quicklist</strong>  </p>
<p>Redis 将链表和 ziplist 结合起来组成了 quicklist。也<strong>就是将多个 ziplist 使用双向指针串起来使用</strong>。这样既满足了快速的插入删除性能，又不会出现太大的空间冗余。</p>
<h2 id="Redis-集合-Set"><a href="#Redis-集合-Set" class="headerlink" title="Redis 集合(Set)"></a>Redis 集合(Set)</h2><p>特殊之处在于 <strong>set 是可以自动排重的</strong></p>
<p> <strong>常用命令</strong>  </p>
<p><code>sadd &lt;key&gt;&lt;value1&gt;&lt;value2&gt; .....</code>将一个或多个 member 元素加入到集合 key 中，已经存在的 member 元素将被忽略<br><code>smembers &lt;key&gt;</code>取出该集合的所有值。<br><code>sismember &lt;key&gt;&lt;value&gt;</code>判断集合<key>是否为含有该<value>值，有 1，没有 0<br><code>scard&lt;key&gt;</code>返回该集合的元素个数。  </value></key></p>
<p><code>srem &lt;key&gt;&lt;value1&gt;&lt;value2&gt; ....</code> 删除集合中的某个元素。<br><code>spop &lt;key&gt;</code>随机从该集合中吐出一个值。<br><code>srandmember &lt;key&gt;&lt;n&gt;</code>随机从该集合中取出 n 个值。不会从集合中删除 。<br><code>smove &lt;source&gt;&lt;destination&gt;value</code> 把集合中一个值从一个集合移动到另一个集合<br><code>sinter &lt;key1&gt;&lt;key2&gt;</code>返回两个集合的交集元素。<br><code>sunion &lt;key1&gt;&lt;key2&gt;</code>返回两个集合的并集元素。<br><code>sdiff &lt;key1&gt;&lt;key2&gt;</code>返回两个集合的差集元素(key1 中的，不包含 key2 中的)  </p>
<p><strong>数据结构</strong>  </p>
<p>Set 数据结构是 dict 字典，<strong>字典是用哈希表实现的</strong>  </p>
<h2 id="Redis-哈希-Hash"><a href="#Redis-哈希-Hash" class="headerlink" title="Redis 哈希(Hash)"></a>Redis 哈希(Hash)</h2><p>Redis hash 是一个键值对集合。Redis hash 是一个 string 类型的 field 和 value 的映射表，hash 特别适合用于存储对象。  </p>
<p><img src="/2022/06/07/redis/image-20220607155709655.png" srcset="/img/loading.gif" lazyload alt="image-20220607155709655"></p>
<p><strong>常用命令</strong></p>
<p><code>hset &lt;key&gt;&lt;field&gt;&lt;value&gt;</code>：给<key>集合中的 <field>键赋值<value><br><code>hget &lt;key1&gt;&lt;field&gt;</code>：从<key1>集合<field>取出 value<br><code>hmset &lt;key1&gt;&lt;field1&gt;&lt;value1&gt;&lt;field2&gt;&lt;value2&gt;...</code> ：批量设置 hash 的值<br><code>hexists&lt;key1&gt;&lt;field&gt;</code>：查看哈希表 key 中， 给定域 field 是否存在。<br><code>hkeys &lt;key&gt;</code>：列出该 hash 集合的所有 field<br><code>hvals &lt;key&gt;：</code>列出该 hash 集合的所有 value<br><code>hincrby &lt;key&gt;&lt;field&gt;&lt;increment&gt;：</code>为哈希表 key 中的域 field 的值加上增量 1 -1<br><code>hsetnx &lt;key&gt;&lt;field&gt;&lt;value&gt;：</code>将哈希表 key 中的域 field 的值设置为 value ， 当且仅当域field 不存在  </field></key1></value></field></key></p>
<p><strong>数据结构</strong>  </p>
<p>Hash 类型对应的数据结构是两种： ziplist（压缩列表）， hashtable（哈希表）。 当field-value 长度较短且个数较少时， 使用 ziplist， 否则使用 hashtable。  </p>
<h2 id="Redis-有序集合-Zset-sorted-set"><a href="#Redis-有序集合-Zset-sorted-set" class="headerlink" title="Redis 有序集合 Zset(sorted set)"></a>Redis 有序集合 Zset(sorted set)</h2><p>Redis 有序集合 zset 与普通集合 set 非常相似，是一个<strong>没有重复元素</strong>的字符串集合。<br>不同之处是有序集合的每个成员都关联了一个<strong>评分（score）</strong>,这个评分（score）被用来按照从最低分到最高分的方式排序集合中的成员。<strong>集合的成员是唯一的，但是评分可以是重复了 。</strong>  </p>
<p><strong>常用命令</strong></p>
<p><code>zadd &lt;key&gt;&lt;score1&gt;&lt;value1&gt;&lt;score2&gt;&lt;value2&gt;…</code>将一个或多个 member 元素及其 score 值加入到有序集 key 当中。<br><code>zrange &lt;key&gt;&lt;start&gt;&lt;stop&gt;</code> [WITHSCORES]返回有序集 key 中，下标在<start><stop></stop>之间的元素带 WITHSCORES，可以让分数一起和值返回到结果集。<br><code>zrangebyscore key minmax [withscores] [limit offset count]</code>返回有序集 key 中，所有 score 值介于 min 和 max 之间(包括等于 min 或 max )的成员。有序集成员按 score 值递增(从小到大)次序排列。<br><code>zrevrangebyscore key maxmin [withscores] [limit offset count]</code>同上，改为从大到小排列。  </start></p>
<p><code>zincrby &lt;key&gt;&lt;increment&gt;&lt;value&gt;</code> 为元素的 score 加上增量<br><code>zrem &lt;key&gt;&lt;value&gt;</code>删除该集合下，指定值的元素<br><code>zcount &lt;key&gt;&lt;min&gt;&lt;max&gt;</code>统计该集合，分数区间内的元素个数<br><code>zrank &lt;key&gt;&lt;value&gt;</code>返回该值在集合中的排名，从 0 开始。  </p>
<p><strong>数据结构</strong></p>
<p><strong>zset 底层使用了两个数据结构</strong><br>（1）hash，hash 的作用就是关联元素 value 和权重 score，保障元素 value 的唯一性，可以通过元素 value 找到相应的 score 值。<br>（2）跳跃表，跳跃表的目的在于给元素 value 排序，根据 score 的范围获取元素列表。  </p>
<p><img src="/2022/06/07/redis/image-20220607161721235.png" srcset="/img/loading.gif" lazyload alt="image-20220607161721235"></p>
<p><strong>从此可以看出跳跃表比有序链表效率要高</strong>  </p>
<h1 id="Redis-的发布和订阅"><a href="#Redis-的发布和订阅" class="headerlink" title="Redis 的发布和订阅"></a>Redis 的发布和订阅</h1><p>Redis 发布订阅 (pub&#x2F;sub) 是一种消息通信模式：发送者 (pub) 发送消息，订阅者(sub) 接收消息  </p>
<p>当订阅者订阅A频道时，A频道发布消息，则订阅者就能收到，如果B频道也发布消息，但订阅者没有订阅，则不会收到。</p>
<p><img src="/2022/06/07/redis/image-20220607221305094.png" srcset="/img/loading.gif" lazyload alt="image-20220607221305094"></p>
<p><strong>命令行实现：</strong></p>
<p>（1）打开客户端的订阅 channel1  ：<code>SUBSCRIBE channel1</code>  </p>
<p>（2）打开另一个客户端，给 channel1 发布消息 hello  ：<code>publish channel1 hello</code>  </p>
<p>（3）打开第一个客户端，可以看到发送的消息</p>
<p><img src="/2022/06/07/redis/image-20220607221433147.png" srcset="/img/loading.gif" lazyload alt="image-20220607221433147"></p>
<h1 id="Redis-新数据类型"><a href="#Redis-新数据类型" class="headerlink" title="Redis 新数据类型"></a>Redis 新数据类型</h1><h2 id="Bitmaps"><a href="#Bitmaps" class="headerlink" title="Bitmaps"></a>Bitmaps</h2><p>​		<strong>在我们平时的开发过程中，会有一些bool类型数据需要存取，比如用户一年的签到记录，签了是1，没签是0，要记录365天。如果使用普通的key&#x2F;value,每个用户要记录365个，当用户数上亿的时候，需要的存储空间是惊人的。</strong></p>
<p>​    <strong>为了解决这个问题，Redis提供了位图数据结构，这样每天的签到记录只占据了一个位，365天就是365个位，46个字节(一个稍长一点的字符串)就可以完全容纳下来，这就大大节约了存储空间。位图的最小单位是bit，每个bit的取值只能是0或1。</strong></p>
<p>Redis 提供了 Bitmaps 这个“数据类型”可以实现对位的操作：  </p>
<p>（1） Bitmaps 本身不是一种数据类型， 实际上它就是字符串（key-value） ，但是它<strong>可以对字符串的位进行操作。</strong><br>（2） Bitmaps 单独提供了一套命令， 所以在 Redis 中使用 Bitmaps 和使用字符串的方法不太相同。 可以把 Bitmaps 想象成一个以位为单位的数组，数组的每个单元只能存储 0 和 1， <strong>数组的下标在 Bitmaps 中叫做偏移量。</strong>  </p>
<p><strong>常用命令：</strong></p>
<p><strong>（1）setbit</strong>  </p>
<p><code>setbit&lt;key&gt;&lt;offset&gt;&lt;value&gt;</code>设置 Bitmaps 中某个偏移量的值（0 或 1）  </p>
<p>实例：<br>        每个独立用户是否访问过网站存放在 Bitmaps 中， 将访问的用户记做 1， 没有访问的用户记做 0， 用偏移量作为用户的 id。  </p>
<p>​		设置键的第 offset 个位的值（从 0 算起） ， 假设现在有 20 个用户，userid&#x3D;1，6， 11， 15， 19 的用户对网站进行了访问  </p>
<p><img src="/2022/06/07/redis/image-20220608094714290.png" srcset="/img/loading.gif" lazyload alt="image-20220608094714290"></p>
<p>注意：</p>
<p>​	由于很多用户id 以一个指定数字（例如 10000） 开头， 直接将用户 id 和Bitmaps 的偏移量对应势必会造成一定的浪费， 通常的做法是每次做 setbit 操作时将用户 id 减去这个指定数字  。</p>
<p><strong>（2）getbit</strong></p>
<p><code>getbit&lt;key&gt;&lt;offset&gt;</code>获取 Bitmaps 中某个偏移量的值  </p>
<p>获取用户id为，15，18，19的用户是否被访问过，如果被访问过值为1，否则为0.</p>
<p><img src="/2022/06/07/redis/image-20220608100244411.png" srcset="/img/loading.gif" lazyload alt="image-20220608100244411"></p>
<p><strong>（3）bitcount</strong>  </p>
<p>统计字符串被设置为 1 的 bit 数  一般情况下，给定的整个字符串都会被进行计数，通过指定额外的 start 或 end 参数，  </p>
<p>start 和 end 参数的设置，都可以使用负数值：比如 -1 表示最后一个位，而 -2 表示倒数第二个位，start、end 是指 bit 组的字节的下标数，二者皆包含 。</p>
<p><code>bitcount&lt;key&gt;[start end]</code> 统计字符串从 start 字节到 end 字节比特值为 1 的数量  </p>
<p>实例：</p>
<p>计算用户 id 在第 1 个字节到第 3 个字  </p>
<p><img src="/2022/06/07/redis/image-20220608100603141.png" srcset="/img/loading.gif" lazyload alt="image-20220608100603141"></p>
<p>举例： K1 【01000001 01000000 00000000 00100001】，对应【0，1，2，3】  </p>
<p><img src="/2022/06/07/redis/image-20220608101336433.png" srcset="/img/loading.gif" lazyload alt="image-20220608101336433"></p>
<p><strong>（4）bitop</strong>  </p>
<p><code>bitop and(or/not/xor) &lt;destkey&gt; [key…]</code>   ： bitop 是一个复合操作， 它可以做多个 Bitmaps 的 and（交集） 、 or（并集） 、 not<br>（非） 、 xor（异或） 操作并将结果保存在 destkey 中 。</p>
<p>**实例 ：计算出两天都访问过网站的用户数量  **（使用and）</p>
<p>​		2020-11-04 日访问网站的 userid&#x3D;1,2,5,9。  </p>
<p>​		2020-11-03 日访问网站的 userid&#x3D;0,1,4,9 。</p>
<p><img src="/2022/06/07/redis/image-20220608101808071.png" srcset="/img/loading.gif" lazyload alt="image-20220608101808071"></p>
<p><img src="/2022/06/07/redis/image-20220608101833339.png" srcset="/img/loading.gif" lazyload alt="image-20220608101833339"></p>
<p><strong>Bitmaps 与 set 对比</strong>  </p>
<p>​		在存储活跃用户时，bitmap要比set要大大节省空间。</p>
<p><img src="/2022/06/07/redis/image-20220608101952307.png" srcset="/img/loading.gif" lazyload alt="image-20220608101952307"></p>
<p>但如果该网站每天的独立访问用户很少， 例如只有 10万（大量的僵尸用户） ， 那么两者的对比如下表所示， 很显然， 这时候使用Bitmaps 就不太合适了， 因为基本上大部分位都是 0  。</p>
<h2 id="HyperLogLog"><a href="#HyperLogLog" class="headerlink" title="HyperLogLog"></a>HyperLogLog</h2><p>在工作当中，我们经常会遇到与统计相关的功能需求，比如统计网站 PV（PageView 页面访问量）,可以使用 Redis 的 incr、incrby 轻松实现  </p>
<p><strong>用于解决UV（独立访客  ）独立 IP 数、搜索记录数等需要去重和计数的问题</strong>  </p>
<p>主要用于基数计算的操作，帮助去重复  ，解决去重问题，有很多方案，为什么要新提出一个这个，例如：</p>
<p>（1）数据存储在 MySQL 表中，使用 distinct count 计算不重复个数<br>（2）使用 Redis 提供的 hash、set、bitmaps 等数据结构来处理  </p>
<p>以上的方案结果精确，但随着数据不断增加，导致占用空间越来越大，对于非常大的数据集是不切实际的。  </p>
<p><strong>HyperLogLog 的优点是，在输入元素的数量或者体积非常非常大时，计算基数所需的空间总是固定的、并且是很小的</strong>  </p>
<p>因为 HyperLogLog 只会根据输入元素来计算基数，而不会储存输入元素本身，所以 HyperLogLog 不能像集合那样，返回输入的各个元素。  </p>
<p><strong>什么是基数?</strong>  比如数据集 {1, 3, 5, 7, 5, 7, 8}， 那么这个数据集的基数集为 {1, 3, 5 ,7, 8},基数(不重复元素)为 5。 基数估计就是在误差可接受的范围内，快速计算基数。  </p>
<p><strong>命令：</strong></p>
<p><strong>（1）pfadd</strong></p>
<p><code>pfadd &lt;key&gt;&lt; element&gt; [element ...]</code> 添加指定元素到 HyperLogLog 中  </p>
<p><img src="/2022/06/07/redis/image-20220608103326649.png" srcset="/img/loading.gif" lazyload alt="image-20220608103326649"></p>
<p><strong>（2）pfcount</strong>  </p>
<p><code>pfcount&lt;key&gt; [key ...]</code> 计算 HLL 的近似基数  ，可以计算多个</p>
<p><img src="/2022/06/07/redis/image-20220608103423389.png" srcset="/img/loading.gif" lazyload alt="image-20220608103423389"></p>
<p><strong>（3）pfmerge</strong>  </p>
<p><code>pfmerge&lt;destkey&gt;&lt;sourcekey&gt; [sourcekey ...]</code> 将一个或多个 HLL 合并后的结果存储在另一个 HLL 中，比如每月活跃用户可以使用每天的活跃用户来合并计算可得  </p>
<p><img src="/2022/06/07/redis/image-20220608103630010.png" srcset="/img/loading.gif" lazyload alt="image-20220608103630010"></p>
<h2 id="Geospatial"><a href="#Geospatial" class="headerlink" title="Geospatial"></a>Geospatial</h2><p>​		<strong>该类型，就是元素的 2 维坐标，在地图上就是经纬度。redis 基于该类型，提供了经纬度设置，查询，范围查询，距离查询，经纬度 Hash 等常见操作。</strong>  </p>
<p><strong>命令</strong></p>
<p><strong>（1）getadd</strong></p>
<p><code>geoadd&lt;key&gt;&lt; longitude&gt;&lt;latitude&gt;&lt;member&gt; [longitude latitude member...]</code> 添加地理位置（经度，纬度，名称）  </p>
<p><img src="/2022/06/07/redis/image-20220608104301235.png" srcset="/img/loading.gif" lazyload alt="image-20220608104301235"></p>
<p><strong>（2）geopos</strong></p>
<p><code>geopos &lt;key&gt;&lt;member&gt; [member...]</code> 获得指定地区的坐标值  </p>
<p><img src="/2022/06/07/redis/image-20220608104401677.png" srcset="/img/loading.gif" lazyload alt="image-20220608104401677"></p>
<p><strong>（3）geodist</strong></p>
<p><code>geodist&lt;key&gt;&lt;member1&gt;&lt;member2&gt; [m|km|ft|mi ]</code> 获取两个位置之间的直线距离  </p>
<p><img src="/2022/06/07/redis/image-20220608104503203.png" srcset="/img/loading.gif" lazyload alt="image-20220608104503203"></p>
<ul>
<li>m 表示单位为米[默认值]。</li>
<li>km 表示单位为千米。</li>
<li>mi 表示单位为英里。</li>
<li>ft 表示单位为英尺。</li>
<li>如果用户没有显式地指定单位参数， 那么 GEODIST 默认使用米作为单位</li>
</ul>
<p><strong>（4）georadius</strong>  </p>
<p><code>georadius&lt;key&gt;&lt; longitude&gt;&lt;latitude&gt;radius m|km|ft|mi</code>   以给定的经纬度为中心，找出某一半径内的元素  </p>
<p><img src="/2022/06/07/redis/image-20220608104720055.png" srcset="/img/loading.gif" lazyload alt="image-20220608104720055"></p>
<h1 id="Redis-Jedis-测试"><a href="#Redis-Jedis-测试" class="headerlink" title="Redis_Jedis_测试"></a>Redis_Jedis_测试</h1><h2 id="Jedis-所需要的-jar-包"><a href="#Jedis-所需要的-jar-包" class="headerlink" title="Jedis 所需要的 jar 包"></a>Jedis 所需要的 jar 包</h2><p><strong>引入依赖：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependency&gt;<br>&lt;groupId&gt;redis.clients&lt;/groupId&gt;<br>&lt;artifactId&gt;jedis&lt;/artifactId&gt;<br>&lt;version&gt;<span class="hljs-number">3.2</span><span class="hljs-number">.0</span>&lt;/version&gt;<br>&lt;/dependency&gt;<br></code></pre></td></tr></table></figure>

<p><strong>连接 Redis 注意事项</strong>  </p>
<ul>
<li>禁用 Linux 的防火墙：Linux(CentOS7)里执行命令</li>
<li>systemctl stop&#x2F;disable firewalld.service</li>
<li>redis.conf 中注释掉 bind 127.0.0.1 ,然后 protected-mode no</li>
</ul>
<h2 id="Jedis-常用操作"><a href="#Jedis-常用操作" class="headerlink" title="Jedis 常用操作"></a>Jedis 常用操作</h2><p><strong>（1）创建测试程序</strong>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">&quot;192.168.86.129&quot;</span>,<span class="hljs-number">6379</span>);<br>    jedis.auth(<span class="hljs-string">&quot;Zlw199805&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">ping</span> <span class="hljs-operator">=</span> jedis.ping();<br>    System.out.println(ping);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>（2）测试：Jedis-API: Key</strong>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 测试：key</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testKey</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">&quot;192.168.86.129&quot;</span>,<span class="hljs-number">6379</span>);<br>    jedis.auth(<span class="hljs-string">&quot;Zlw199805&quot;</span>);<br>    jedis.set(<span class="hljs-string">&quot;k1&quot;</span>,<span class="hljs-string">&quot;v1&quot;</span>);<br>    jedis.set(<span class="hljs-string">&quot;k2&quot;</span>,<span class="hljs-string">&quot;v2&quot;</span>);<br>    jedis.set(<span class="hljs-string">&quot;k3&quot;</span>,<span class="hljs-string">&quot;v3&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">k2</span> <span class="hljs-operator">=</span> jedis.get(<span class="hljs-string">&quot;k2&quot;</span>);<br>    System.out.println(k2);<br>    Set&lt;String&gt; keys = jedis.keys(<span class="hljs-string">&quot;*&quot;</span>);<br>    <span class="hljs-keyword">for</span> (String key:keys)&#123;<br>        System.out.print(key+<span class="hljs-string">&quot; &quot;</span>);<br>    &#125;<br>    System.out.println();<br>    System.out.println(jedis.exists(<span class="hljs-string">&quot;k3&quot;</span>));<br>    System.out.println(jedis.ttl(<span class="hljs-string">&quot;k2&quot;</span>));<span class="hljs-comment">//-1 表示永不过期</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2022/06/07/redis/image-20220608114625329.png" srcset="/img/loading.gif" lazyload alt="image-20220608114625329"></p>
<p><strong>（3）测试 ：Jedis-API: String</strong>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 测试String</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">StringTest</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">&quot;192.168.86.129&quot;</span>,<span class="hljs-number">6379</span>);<br>        jedis.auth(<span class="hljs-string">&quot;Zlw199805&quot;</span>);<br>        jedis.flushDB();<br>        jedis.set(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;zlw&quot;</span>);<br>        jedis.mset(<span class="hljs-string">&quot;name1&quot;</span>,<span class="hljs-string">&quot;jack&quot;</span>,<span class="hljs-string">&quot;name2&quot;</span>,<span class="hljs-string">&quot;mary&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> jedis.get(<span class="hljs-string">&quot;name&quot;</span>);<br>        System.out.println(name);<br>        List&lt;String&gt; name1 = jedis.mget(<span class="hljs-string">&quot;name1&quot;</span>,<span class="hljs-string">&quot;name2&quot;</span>);<br>        System.out.println(name1);<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> jedis.strlen(<span class="hljs-string">&quot;name&quot;</span>);<br>        System.out.println(len);<br><br>    &#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2022/06/07/redis/image-20220608134027626.png" srcset="/img/loading.gif" lazyload alt="image-20220608134027626"></p>
<p><strong>（4）测试：Jedis-API: List</strong>  </p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 测试list</span><br><span class="hljs-comment">     */</span><br>    @Test<br>    <span class="hljs-built_in">public</span> <span class="hljs-type">void</span> ListTest()&#123;<br>        Jedis jedis = <span class="hljs-built_in">new</span> Jedis(&quot;192.168.86.129&quot;,<span class="hljs-number">6379</span>);<br>        jedis.auth(&quot;Zlw199805&quot;);<br>        jedis.flushDB();<br>        jedis.lpush(&quot;name&quot;, &quot;zlw&quot;, &quot;hhh&quot;, &quot;aaa&quot;);<br>        String <span class="hljs-type">name</span> = jedis.lpop(&quot;name&quot;);<br>        <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(<span class="hljs-type">name</span>);<br>        List&lt;String&gt; name1 = jedis.lrange(&quot;name&quot;, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>);<br>        <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(name1);<br>        Long len = jedis.llen(&quot;name&quot;);<br>        <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(len);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2022/06/07/redis/image-20220608133540388.png" srcset="/img/loading.gif" lazyload alt="image-20220608133540388"></p>
<p><strong>（5）测试：Jedis-API: set</strong>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 测试set</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setTest</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">&quot;192.168.86.129&quot;</span>,<span class="hljs-number">6379</span>);<br>    jedis.auth(<span class="hljs-string">&quot;Zlw199805&quot;</span>);<br>    jedis.flushDB();<br>    jedis.sadd(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;jack&quot;</span>,<span class="hljs-string">&quot;mary&quot;</span>,<span class="hljs-string">&quot;zlw&quot;</span>);<br>    Set&lt;String&gt; name = jedis.smembers(<span class="hljs-string">&quot;name&quot;</span>);<br>    System.out.println(name);<br>    <span class="hljs-comment">//判断集合中是否有：zlw</span><br>    System.out.println(jedis.sismember(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;zlw&quot;</span>));<br>    <span class="hljs-comment">//返回集合中元素的数量</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> jedis.scard(<span class="hljs-string">&quot;name&quot;</span>);<br>    System.out.println(len);<br>    <span class="hljs-comment">//删除集合中的元素</span><br>    jedis.srem(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;zlw&quot;</span>);<br>    Set&lt;String&gt; name1 = jedis.smembers(<span class="hljs-string">&quot;name&quot;</span>);<br>    System.out.println(name1);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2022/06/07/redis/image-20220608134454960.png" srcset="/img/loading.gif" lazyload alt="image-20220608134454960"></p>
<p><strong>（6）测试：Jedis-API: hash</strong>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 测试hash</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hashTest</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">&quot;192.168.86.129&quot;</span>,<span class="hljs-number">6379</span>);<br>        jedis.auth(<span class="hljs-string">&quot;Zlw199805&quot;</span>);<br>        jedis.flushDB();<br>        jedis.hset(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;zlw&quot;</span>,<span class="hljs-string">&quot;20&quot;</span>);<br>        System.out.println(jedis.hget(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;zlw&quot;</span>));<br>        Map&lt;String,String&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;jack&quot;</span>,<span class="hljs-string">&quot;22&quot;</span>);<br>        map.put(<span class="hljs-string">&quot;mary&quot;</span>,<span class="hljs-string">&quot;21&quot;</span>);<br>        jedis.hset(<span class="hljs-string">&quot;names&quot;</span>,map);<br>        System.out.println(jedis.hmget(<span class="hljs-string">&quot;names&quot;</span>,<span class="hljs-string">&quot;jack&quot;</span>,<span class="hljs-string">&quot;mary&quot;</span>));<br>        <span class="hljs-comment">//查看是否有元素</span><br>        System.out.println(jedis.hexists(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;zlw&quot;</span>));<br>        <span class="hljs-comment">//列出key中所有的filed</span><br>        System.out.println(jedis.hkeys(<span class="hljs-string">&quot;names&quot;</span>));<br>        <span class="hljs-comment">//列出key中所有的value</span><br>        System.out.println(jedis.hvals(<span class="hljs-string">&quot;names&quot;</span>));<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2022/06/07/redis/image-20220608135235012.png" srcset="/img/loading.gif" lazyload alt="image-20220608135235012"></p>
<p><strong>（7）测试：Jedis-API: zset</strong>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 测试zset</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@Test</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">zsetTest</span><span class="hljs-params">()</span>&#123;<br>       <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">&quot;192.168.86.129&quot;</span>,<span class="hljs-number">6379</span>);<br>       jedis.auth(<span class="hljs-string">&quot;Zlw199805&quot;</span>);<br>       jedis.flushDB();<br>       jedis.zadd(<span class="hljs-string">&quot;name1&quot;</span>,<span class="hljs-number">100d</span>,<span class="hljs-string">&quot;zlw&quot;</span>);<br>       jedis.zadd(<span class="hljs-string">&quot;name1&quot;</span>,<span class="hljs-number">99d</span>,<span class="hljs-string">&quot;jack&quot;</span>);<br>       jedis.zadd(<span class="hljs-string">&quot;name1&quot;</span>,<span class="hljs-number">98d</span>,<span class="hljs-string">&quot;mary&quot;</span>);<br>       System.out.println(jedis.zrange(<span class="hljs-string">&quot;name1&quot;</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>));<br>       System.out.println(jedis.zrangeByScore(<span class="hljs-string">&quot;name1&quot;</span>, <span class="hljs-number">99</span>, <span class="hljs-number">100</span>));<br>       jedis.zincrby(<span class="hljs-string">&quot;name1&quot;</span>,<span class="hljs-number">100</span>,<span class="hljs-string">&quot;mary&quot;</span>);<br>       System.out.println(jedis.zrange(<span class="hljs-string">&quot;name1&quot;</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>));<br>   &#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2022/06/07/redis/image-20220608140213830.png" srcset="/img/loading.gif" lazyload alt="image-20220608140213830"></p>
<h1 id="Redis-Jedis-实例-完成手机验证"><a href="#Redis-Jedis-实例-完成手机验证" class="headerlink" title="Redis_Jedis_实例 (完成手机验证)"></a>Redis_Jedis_实例 (完成手机验证)</h1><h2 id="完成一个手机验证码功能"><a href="#完成一个手机验证码功能" class="headerlink" title="完成一个手机验证码功能"></a>完成一个手机验证码功能</h2><p><strong>要求：</strong></p>
<p>（1）输入手机号，点击发送后随机生成 6 位数字码，2 分钟有效</p>
<p>（2）输入验证码，点击验证，返回成功或失败</p>
<p>（3）每个手机号每天只能输入 3 次  </p>
<p><strong>对要求的分析：</strong></p>
<p><img src="/2022/06/07/redis/image-20220608140726491.png" srcset="/img/loading.gif" lazyload alt="image-20220608140726491"></p>
<p><strong>代码为：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.zlw.redis;<br><br><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;<br><br><span class="hljs-keyword">import</span> java.util.Random;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PhoneCode</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">phone</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;18840613021&quot;</span>;<br>        <span class="hljs-type">PhoneCode</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhoneCode</span>();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> p.getCode();<br><span class="hljs-comment">//        String code = &quot;399675&quot;;</span><br><span class="hljs-comment">//        p.VerCode(phone,code);</span><br>        p.setCodeToRedis(phone,code);<br><br>    &#125;<br>    <span class="hljs-comment">//1.生成随机6位数字验证</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getCode</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;i&lt;<span class="hljs-number">6</span>;i++)&#123;<br>            code +=random.nextInt(<span class="hljs-number">10</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> code;<br>    &#125;<br><br>    <span class="hljs-comment">//将发送验证码的数量放入到redis中，设置每个手机一天之内只能发送三次，放入redis中，设置验证码在2分钟内有效，</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCodeToRedis</span><span class="hljs-params">(String phone, String code)</span>&#123;<br>        <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">&quot;192.168.86.129&quot;</span>,<span class="hljs-number">6379</span>);<br>        jedis.auth(<span class="hljs-string">&quot;Zlw199805&quot;</span>);<br>        <span class="hljs-comment">//验证码数量的key</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">codeCount</span> <span class="hljs-operator">=</span> phone + <span class="hljs-string">&quot;:count&quot;</span>;<br>        <span class="hljs-comment">//验证码两分钟有效的key</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">codeVer</span> <span class="hljs-operator">=</span> phone + <span class="hljs-string">&quot;:ver&quot;</span>;<br><br>        <span class="hljs-keyword">if</span> (jedis.get(codeCount)==<span class="hljs-literal">null</span>)&#123;<br>            jedis.setex(codeCount,<span class="hljs-number">24</span>*<span class="hljs-number">60</span>*<span class="hljs-number">60</span>,<span class="hljs-string">&quot;1&quot;</span>);<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Integer.parseInt(jedis.get(codeCount) )&lt;=<span class="hljs-number">2</span>)&#123;<br>            jedis.incr(codeCount);<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Integer.parseInt(jedis.get(codeCount) )&gt;<span class="hljs-number">2</span>)&#123;<br>            System.out.println(<span class="hljs-string">&quot;今日发送已经超过三日，明日再来吧~~&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<span class="hljs-comment">//如果发送失败了，就不会将验证码存入到redis中了，因此结束return;</span><br>        &#125;<br><br>        jedis.setex(codeVer,<span class="hljs-number">120</span>,code);<br>        jedis.close();<br>    &#125;<br><br>    <span class="hljs-comment">//验证 验证码和输入的是否相等</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">VerCode</span><span class="hljs-params">(String phone,String code)</span>&#123;<br>        <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">&quot;192.168.86.129&quot;</span>,<span class="hljs-number">6379</span>);<br>        jedis.auth(<span class="hljs-string">&quot;Zlw199805&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">codeVer</span> <span class="hljs-operator">=</span> phone + <span class="hljs-string">&quot;:ver&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code1</span> <span class="hljs-operator">=</span> jedis.get(codeVer);<br>        <span class="hljs-keyword">if</span> (code1.equals(code))&#123;<br>            System.out.println(<span class="hljs-string">&quot;成功&quot;</span>);<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;失败&quot;</span>);<br>        &#125;<br>        jedis.close();<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h1 id="Redis-与-Spring-Boot-整合"><a href="#Redis-与-Spring-Boot-整合" class="headerlink" title="Redis 与 Spring Boot 整合"></a>Redis 与 Spring Boot 整合</h1><p><strong>整合步骤：</strong></p>
<p><strong>（1）在 pom.xml 文件中引入 redis 相关依赖</strong>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;!-- redis --&gt;<br>&lt;dependency&gt;<br>&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>&lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;<br>&lt;/dependency&gt;<br>&lt;!-- spring2.X 集成 redis 所需 common-pool2--&gt;<br>&lt;dependency&gt;<br>&lt;groupId&gt;org.apache.commons&lt;/groupId&gt;<br>&lt;artifactId&gt;commons-pool2&lt;/artifactId&gt;<br>&lt;version&gt;<span class="hljs-number">2.6</span><span class="hljs-number">.0</span>&lt;/version&gt;<br>&lt;/dependency&gt;<br></code></pre></td></tr></table></figure>

<p><strong>（2）application.properties 配置 redis 配置</strong>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">#Redis 服务器地址<br>spring.redis.host=<span class="hljs-number">192.168</span><span class="hljs-number">.140</span><span class="hljs-number">.136</span><br>#Redis 服务器连接端口<br>spring.redis.port=<span class="hljs-number">6379</span><br>#Redis 数据库索引（ 默认为 <span class="hljs-number">0</span>）<br>spring.redis.database= <span class="hljs-number">0</span><br>#连接超时时间（ 毫秒）<br>spring.redis.timeout=<span class="hljs-number">1800000</span><br>#连接池最大连接数（ 使用负值表示没有限制）<br>spring.redis.lettuce.pool.max-active=<span class="hljs-number">20</span><br>#最大阻塞等待时间(负数表示没限制)<br>spring.redis.lettuce.pool.max-wait=-<span class="hljs-number">1</span><br>#连接池中的最大空闲连接<br>spring.redis.lettuce.pool.max-idle=<span class="hljs-number">5</span><br>#连接池中的最小空闲连接<br>spring.redis.lettuce.pool.min-idle=<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<p><strong>（3）添加 redis 配置类</strong>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableCaching</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CachingConfigurerSupport</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="hljs-title function_">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory factory)</span> &#123;<br>        RedisTemplate&lt;String, Object&gt; template = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();<br>        RedisSerializer&lt;String&gt; redisSerializer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>();<br>        <span class="hljs-type">Jackson2JsonRedisSerializer</span> <span class="hljs-variable">jackson2JsonRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonRedisSerializer</span>(Object.class);<br>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">om</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);<br>        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);<br>        jackson2JsonRedisSerializer.setObjectMapper(om);<br>        template.setConnectionFactory(factory);<br><span class="hljs-comment">//key 序列化方式</span><br>        template.setKeySerializer(redisSerializer);<br><span class="hljs-comment">//value 序列化</span><br>        template.setValueSerializer(jackson2JsonRedisSerializer);<br><span class="hljs-comment">//value hashmap 序列化</span><br>        template.setHashValueSerializer(jackson2JsonRedisSerializer);<br>        <span class="hljs-keyword">return</span> template;<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> CacheManager <span class="hljs-title function_">cacheManager</span><span class="hljs-params">(RedisConnectionFactory factory)</span> &#123;<br>        RedisSerializer&lt;String&gt; redisSerializer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>();<br>        <span class="hljs-type">Jackson2JsonRedisSerializer</span> <span class="hljs-variable">jackson2JsonRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonRedisSerializer</span>(Object.class);<br><span class="hljs-comment">//解决查询缓存转换异常的问题</span><br>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">om</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);<br>        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);<br>        jackson2JsonRedisSerializer.setObjectMapper(om);<br><span class="hljs-comment">// 配置序列化（ 解决乱码的问题） ,过期时间 600 秒</span><br>        <span class="hljs-type">RedisCacheConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> RedisCacheConfiguration.defaultCacheConfig().<br>                entryTtl(Duration.ofSeconds(<span class="hljs-number">600</span>)).<br>                serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(redisSerializer)).<br>                serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(jackson2JsonRedisSerializer))<br>                .disableCachingNullValues();<br>        <span class="hljs-type">RedisCacheManager</span> <span class="hljs-variable">cacheManager</span> <span class="hljs-operator">=</span> RedisCacheManager.builder(factory).cacheDefaults(config).build();<br>        <span class="hljs-keyword">return</span> cacheManager;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>瑞吉外卖中的配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Redis配置类</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CachingConfigurerSupport</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="hljs-title function_">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory connectionFactory)</span> &#123;<br><br>        RedisTemplate&lt;Object, Object&gt; redisTemplate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();<br><br>        <span class="hljs-comment">//默认的Key序列化器为：JdkSerializationRedisSerializer</span><br>        redisTemplate.setKeySerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>());<br>        redisTemplate.setHashKeySerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>());<br><br>        redisTemplate.setConnectionFactory(connectionFactory);<br><br>        <span class="hljs-keyword">return</span> redisTemplate;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><strong>（4）测试</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/redisTest&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisTestController</span> &#123;<br>	<span class="hljs-meta">@Autowired</span><br>	<span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br>	<span class="hljs-meta">@GetMapping</span><br>	<span class="hljs-keyword">public</span> String <span class="hljs-title function_">testRedis</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-comment">//设置值到 redis</span><br>		redisTemplate.opsForValue().set(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;lucy&quot;</span>);<br>		<span class="hljs-comment">//从 redis 获取值</span><br>		<span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> (String)redisTemplate.opsForValue().get(<span class="hljs-string">&quot;name&quot;</span>);<br>		<span class="hljs-keyword">return</span> name;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>瑞吉外卖中的测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.itheima.test;<br><br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.connection.DataType;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.*;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Set;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringDataRedisTest</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 操作String类型数据</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testString</span><span class="hljs-params">()</span>&#123;<br>        redisTemplate.opsForValue().set(<span class="hljs-string">&quot;city123&quot;</span>,<span class="hljs-string">&quot;beijing&quot;</span>);<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (String) redisTemplate.opsForValue().get(<span class="hljs-string">&quot;city123&quot;</span>);<br>        System.out.println(value);<br><br>        redisTemplate.opsForValue().set(<span class="hljs-string">&quot;key1&quot;</span>,<span class="hljs-string">&quot;value1&quot;</span>,<span class="hljs-number">10l</span>, TimeUnit.SECONDS);<br><br>        <span class="hljs-type">Boolean</span> <span class="hljs-variable">aBoolean</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().setIfAbsent(<span class="hljs-string">&quot;city1234&quot;</span>, <span class="hljs-string">&quot;nanjing&quot;</span>);<br>        System.out.println(aBoolean);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 操作Hash类型数据</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testHash</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">HashOperations</span> <span class="hljs-variable">hashOperations</span> <span class="hljs-operator">=</span> redisTemplate.opsForHash();<br><br>        <span class="hljs-comment">//存值</span><br>        hashOperations.put(<span class="hljs-string">&quot;002&quot;</span>,<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;xiaoming&quot;</span>);<br>        hashOperations.put(<span class="hljs-string">&quot;002&quot;</span>,<span class="hljs-string">&quot;age&quot;</span>,<span class="hljs-string">&quot;20&quot;</span>);<br>        hashOperations.put(<span class="hljs-string">&quot;002&quot;</span>,<span class="hljs-string">&quot;address&quot;</span>,<span class="hljs-string">&quot;bj&quot;</span>);<br><br>        <span class="hljs-comment">//取值</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> (String) hashOperations.get(<span class="hljs-string">&quot;002&quot;</span>, <span class="hljs-string">&quot;age&quot;</span>);<br>        System.out.println(age);<br><br>        <span class="hljs-comment">//获得hash结构中的所有字段</span><br>        <span class="hljs-type">Set</span> <span class="hljs-variable">keys</span> <span class="hljs-operator">=</span> hashOperations.keys(<span class="hljs-string">&quot;002&quot;</span>);<br>        <span class="hljs-keyword">for</span> (Object key : keys) &#123;<br>            System.out.println(key);<br>        &#125;<br><br>        <span class="hljs-comment">//获得hash结构中的所有值</span><br>        <span class="hljs-type">List</span> <span class="hljs-variable">values</span> <span class="hljs-operator">=</span> hashOperations.values(<span class="hljs-string">&quot;002&quot;</span>);<br>        <span class="hljs-keyword">for</span> (Object value : values) &#123;<br>            System.out.println(value);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 操作List类型的数据</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testList</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">ListOperations</span> <span class="hljs-variable">listOperations</span> <span class="hljs-operator">=</span> redisTemplate.opsForList();<br><br>        <span class="hljs-comment">//存值</span><br>        listOperations.leftPush(<span class="hljs-string">&quot;mylist&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>);<br>        listOperations.leftPushAll(<span class="hljs-string">&quot;mylist&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>,<span class="hljs-string">&quot;c&quot;</span>,<span class="hljs-string">&quot;d&quot;</span>);<br><br>        <span class="hljs-comment">//取值</span><br>        List&lt;String&gt; mylist = listOperations.range(<span class="hljs-string">&quot;mylist&quot;</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">for</span> (String value : mylist) &#123;<br>            System.out.println(value);<br>        &#125;<br><br>        <span class="hljs-comment">//获得列表长度 llen</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> listOperations.size(<span class="hljs-string">&quot;mylist&quot;</span>);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">lSize</span> <span class="hljs-operator">=</span> size.intValue();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; lSize; i++) &#123;<br>            <span class="hljs-comment">//出队列</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">element</span> <span class="hljs-operator">=</span> (String) listOperations.rightPop(<span class="hljs-string">&quot;mylist&quot;</span>);<br>            System.out.println(element);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 操作Set类型的数据</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSet</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">SetOperations</span> <span class="hljs-variable">setOperations</span> <span class="hljs-operator">=</span> redisTemplate.opsForSet();<br><br>        <span class="hljs-comment">//存值</span><br>        setOperations.add(<span class="hljs-string">&quot;myset&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>,<span class="hljs-string">&quot;c&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>);<br><br>        <span class="hljs-comment">//取值</span><br>        Set&lt;String&gt; myset = setOperations.members(<span class="hljs-string">&quot;myset&quot;</span>);<br>        <span class="hljs-keyword">for</span> (String o : myset) &#123;<br>            System.out.println(o);<br>        &#125;<br><br>        <span class="hljs-comment">//删除成员</span><br>        setOperations.remove(<span class="hljs-string">&quot;myset&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>);<br><br>        <span class="hljs-comment">//取值</span><br>        myset = setOperations.members(<span class="hljs-string">&quot;myset&quot;</span>);<br>        <span class="hljs-keyword">for</span> (String o : myset) &#123;<br>            System.out.println(o);<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 操作ZSet类型的数据</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testZset</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">ZSetOperations</span> <span class="hljs-variable">zSetOperations</span> <span class="hljs-operator">=</span> redisTemplate.opsForZSet();<br><br>        <span class="hljs-comment">//存值</span><br>        zSetOperations.add(<span class="hljs-string">&quot;myZset&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-number">10.0</span>);<br>        zSetOperations.add(<span class="hljs-string">&quot;myZset&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>,<span class="hljs-number">11.0</span>);<br>        zSetOperations.add(<span class="hljs-string">&quot;myZset&quot;</span>,<span class="hljs-string">&quot;c&quot;</span>,<span class="hljs-number">12.0</span>);<br>        zSetOperations.add(<span class="hljs-string">&quot;myZset&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-number">13.0</span>);<br><br>        <span class="hljs-comment">//取值</span><br>        Set&lt;String&gt; myZset = zSetOperations.range(<span class="hljs-string">&quot;myZset&quot;</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">for</span> (String s : myZset) &#123;<br>            System.out.println(s);<br>        &#125;<br><br>        <span class="hljs-comment">//修改分数</span><br>        zSetOperations.incrementScore(<span class="hljs-string">&quot;myZset&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>,<span class="hljs-number">20.0</span>);<br><br>        <span class="hljs-comment">//取值</span><br>        myZset = zSetOperations.range(<span class="hljs-string">&quot;myZset&quot;</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">for</span> (String s : myZset) &#123;<br>            System.out.println(s);<br>        &#125;<br><br>        <span class="hljs-comment">//删除成员</span><br>        zSetOperations.remove(<span class="hljs-string">&quot;myZset&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>);<br><br>        <span class="hljs-comment">//取值</span><br>        myZset = zSetOperations.range(<span class="hljs-string">&quot;myZset&quot;</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">for</span> (String s : myZset) &#123;<br>            System.out.println(s);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 通用操作，针对不同的数据类型都可以操作</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCommon</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">//获取Redis中所有的key</span><br>        Set&lt;String&gt; keys = redisTemplate.keys(<span class="hljs-string">&quot;*&quot;</span>);<br>        <span class="hljs-keyword">for</span> (String key : keys) &#123;<br>            System.out.println(key);<br>        &#125;<br><br>        <span class="hljs-comment">//判断某个key是否存在</span><br>        <span class="hljs-type">Boolean</span> <span class="hljs-variable">itcast</span> <span class="hljs-operator">=</span> redisTemplate.hasKey(<span class="hljs-string">&quot;itcast&quot;</span>);<br>        System.out.println(itcast);<br><br>        <span class="hljs-comment">//删除指定key</span><br>        redisTemplate.delete(<span class="hljs-string">&quot;myZset&quot;</span>);<br><br>        <span class="hljs-comment">//获取指定key对应的value的数据类型</span><br>        <span class="hljs-type">DataType</span> <span class="hljs-variable">dataType</span> <span class="hljs-operator">=</span> redisTemplate.type(<span class="hljs-string">&quot;myset&quot;</span>);<br>        System.out.println(dataType.name());<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<h1 id="Redis-事务"><a href="#Redis-事务" class="headerlink" title="Redis_事务"></a>Redis_事务</h1><p><strong>Redis 事务的主要作用就是串联多个命令防止别的命令插队</strong>  </p>
<p>从输入 Multi 命令开始，输入的命令都会依次进入命令队列中，但不会执行，直到输入Exec 后，Redis 会将之前的命令队列中的命令依次执行。组队的过程中可以通过 discard 来放弃组队。  </p>
<p><img src="/2022/06/07/redis/image-20220609132109343.png" srcset="/img/loading.gif" lazyload alt="image-20220609132109343"></p>
<h2 id="事务的错误处理"><a href="#事务的错误处理" class="headerlink" title="事务的错误处理"></a>事务的错误处理</h2><ul>
<li>组队中某个命令出现了报告错误，执行时整个的所有队列都会被取消  </li>
<li>如果执行阶段某个命令报出了错误，则只有报错的命令不会被执行，而其他的命令都会执行，不会回滚  。因此Redis不具有原子性。</li>
</ul>
<h2 id="悲观锁和乐观锁"><a href="#悲观锁和乐观锁" class="headerlink" title="悲观锁和乐观锁"></a>悲观锁和乐观锁</h2><p><strong>悲观锁</strong></p>
<p>​		就是很悲观，每次去拿数据的时候都认为别人会修改<strong>，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会 block 直到它拿到锁</strong>。传统的关系型数据库里边就用到了很多这种锁机制，比如行锁，表锁等，读锁，写锁等，都是在做操作之前先上锁。  </p>
<p><img src="/2022/06/07/redis/image-20220609132539677.png" srcset="/img/loading.gif" lazyload alt="image-20220609132539677"></p>
<p><strong>乐观锁</strong></p>
<p>就是很乐观，<strong>每次去拿数据的时候都认为别人不会修改，所以不会上锁</strong>，但是<strong>在更新的时候会判断一下在此期间别人有没有去更新这个数据，可以使用版本号等机制。</strong>  乐观锁适用于多读的应用类型，这样可以提高吞吐量。<strong>Redis 就是利用这种 check-and-set 机制实现事务的。</strong>  </p>
<h2 id="WATCH-key-key-…"><a href="#WATCH-key-key-…" class="headerlink" title="WATCH key [key …]"></a>WATCH key [key …]</h2><p>在执行 multi 之前，先执行 watch key1 [key2],可以监视一个(或多个) key ，<strong>如果在事务执行之前这个(或这些) key 被其他命令所改动，那么事务将被打断</strong>  </p>
<p><strong>unwatch</strong>  ：取消 WATCH 命令对所有 key 的监视  </p>
<h2 id="Redis事务的相关指令"><a href="#Redis事务的相关指令" class="headerlink" title="Redis事务的相关指令"></a>Redis事务的相关指令</h2><p>（1）WATCH命令：乐观锁，可以为Redis事务提供check-and-set(CAS)行为。可以监控一个或多个键，一旦有一个被修改和删除，之后的事务不会执行。<br>（2）MULTI：开启一个事务，MULTI执行后，客户端可以向服务器发送多条命令，这些命令不会立即执行，而时被放入到一个队列中，当EXEC命令被调用时，所有的队列命令才会执行。</p>
<p>（3）EXEC：执行事务块内的命令，返回事务块内所有命令的返回值，按命令执行先后顺序排列，操作被打断时，返回nil。</p>
<p>（4）UNWATCH：可以取消watch对所有key的监控。</p>
<h2 id="Redis-事务三特性"><a href="#Redis-事务三特性" class="headerlink" title="Redis 事务三特性"></a>Redis 事务三特性</h2><p>（1）单独的隔离操作</p>
<ul>
<li>事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。</li>
</ul>
<p>（2）没有隔离级别的概念  </p>
<ul>
<li>队列中的命令没有提交之前都不会实际被执行，因为事务提交前任何指令都不会被实际执行</li>
</ul>
<p>（3）不保证原子性  </p>
<ul>
<li>事务中如果有一条命令执行失败，其后的命令仍然会被执行，没有回滚</li>
</ul>
<h1 id="Redis-事务-秒杀案例"><a href="#Redis-事务-秒杀案例" class="headerlink" title="Redis-事务-秒杀案例"></a>Redis-事务-秒杀案例</h1><p>最基本的案例：最基本的代码：</p>
<p><strong>代码为：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//秒杀过程</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">doSecKill</span><span class="hljs-params">(String uid,String prodid)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>   <span class="hljs-comment">//1.判断uid和proid是否为空，如果为空则不能秒杀</span><br>   <span class="hljs-keyword">if</span> (uid==<span class="hljs-literal">null</span> || prodid==<span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>   <span class="hljs-comment">//设置key，产品的key和用户的key</span><br>   <span class="hljs-type">String</span> <span class="hljs-variable">proKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sk:&quot;</span> + prodid + <span class="hljs-string">&quot;:pt&quot;</span>;<br>   <span class="hljs-type">String</span> <span class="hljs-variable">usrKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sk:&quot;</span> + uid + <span class="hljs-string">&quot;:pt&quot;</span>;<br><br>   <span class="hljs-comment">//判断库存是否为null，null证明秒杀没有开始</span><br>   <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">&quot;192.168.86.129&quot;</span>,<span class="hljs-number">6379</span>);<br>   jedis.auth(<span class="hljs-string">&quot;Zlw199805&quot;</span>);<br>   <span class="hljs-keyword">if</span> (jedis.get(proKey)==<span class="hljs-literal">null</span>)&#123;<br>      System.out.println(<span class="hljs-string">&quot;秒杀还没有开始&quot;</span>);<br>      jedis.close();<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>   &#125;<br>   <span class="hljs-comment">//判断库存是否够用，小于1 证明秒杀完成</span><br>   <span class="hljs-keyword">if</span> (Integer.parseInt(jedis.get(proKey) )&lt;=<span class="hljs-number">0</span>)&#123;<br>      System.out.println(<span class="hljs-string">&quot;秒杀结束&quot;</span>);<br>      jedis.close();<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>   &#125;<br><br>   <span class="hljs-comment">//判断用户是否已经秒杀过一次，同一个用户只能秒杀一次</span><br>   <span class="hljs-keyword">if</span> (jedis.sismember(usrKey,uid))&#123;<br>      System.out.println(<span class="hljs-string">&quot;该用户已经秒杀完成，不可以重复秒杀&quot;</span>);<br>      jedis.close();<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>   &#125;<br><br>   <span class="hljs-comment">//进行秒杀商品数量减1</span><br>   jedis.decr(proKey);<br>   <span class="hljs-comment">//加入用户</span><br>   jedis.sadd(usrKey,uid);<br>   System.out.println(<span class="hljs-string">&quot;秒杀成功！&quot;</span>);<br>   jedis.close();<br>   <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>但在以上的这段代码中，会发生连接超时和超卖问题（库存存在负数了）。</strong></p>
<p><strong>（1）修改连接超时问题：</strong></p>
<p>​		通过数据库连接池实现：</p>
<p><strong>redis数据库连接池：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JedisPoolUtil</span> &#123;<br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">JedisPool</span> <span class="hljs-variable">jedisPool</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-title function_">JedisPoolUtil</span><span class="hljs-params">()</span> &#123;<br>   &#125;<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> JedisPool <span class="hljs-title function_">getJedisPoolInstance</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == jedisPool) &#123;<br>         <span class="hljs-keyword">synchronized</span> (JedisPoolUtil.class) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == jedisPool) &#123;<br>               <span class="hljs-type">JedisPoolConfig</span> <span class="hljs-variable">poolConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPoolConfig</span>();<br>               poolConfig.setMaxTotal(<span class="hljs-number">200</span>);<br>               poolConfig.setMaxIdle(<span class="hljs-number">32</span>);<br>               poolConfig.setMaxWaitMillis(<span class="hljs-number">100</span>*<span class="hljs-number">1000</span>);<br>               poolConfig.setBlockWhenExhausted(<span class="hljs-literal">true</span>);<br>               poolConfig.setTestOnBorrow(<span class="hljs-literal">true</span>);  <span class="hljs-comment">// ping  PONG</span><br>             <br>               jedisPool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPool</span>(poolConfig, <span class="hljs-string">&quot;192.168.86.129&quot;</span>, <span class="hljs-number">6379</span>, <span class="hljs-number">60000</span> );<br>            &#125;<br>         &#125;<br>      &#125;<br>      <span class="hljs-keyword">return</span> jedisPool;<br>   &#125;<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">release</span><span class="hljs-params">(JedisPool jedisPool, Jedis jedis)</span> &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != jedis) &#123;<br>         jedisPool.returnResource(jedis);<br>      &#125;<br>   &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>将秒杀系统中的jedis对象，通过数据库连接池创建。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//		Jedis jedis = new Jedis(&quot;192.168.86.129&quot;,6379);</span><br><span class="hljs-comment">//		jedis.auth(&quot;Zlw199805&quot;);</span><br>		<span class="hljs-comment">//通过连接池实现</span><br>		<span class="hljs-type">JedisPool</span> <span class="hljs-variable">jedisPoolInstance</span> <span class="hljs-operator">=</span> JedisPoolUtil.getJedisPoolInstance();<br>		<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPoolInstance.getResource();<br>		jedis.auth(<span class="hljs-string">&quot;Zlw199805&quot;</span>);<br></code></pre></td></tr></table></figure>

<p><strong>（2）超卖问题</strong></p>
<p><strong>使用事务中的乐观锁监视即可。</strong></p>
<p><strong>代码为：</strong></p>
<ul>
<li><p>第一步监视商品的数量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//监视商品的数量</span><br>		jedis.watch(proKey);<br></code></pre></td></tr></table></figure>
</li>
<li><p>第二步：增加事务，商品数量减1 ，增加用户，执行事务，判断事务执行是否失败</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//增加事务</span><br>		<span class="hljs-type">Transaction</span> <span class="hljs-variable">multi</span> <span class="hljs-operator">=</span> jedis.multi();<br>		<span class="hljs-comment">//进行秒杀商品数量减1</span><br><span class="hljs-comment">//		jedis.decr(proKey);</span><br>		<span class="hljs-comment">//减少库存</span><br>		multi.decr(proKey);<br>		<span class="hljs-comment">//加入用户</span><br><span class="hljs-comment">//		jedis.sadd(usrKey,uid);</span><br>		<span class="hljs-comment">//增加成功的用户</span><br>		multi.sadd(usrKey,uid);<br><br>		<span class="hljs-comment">//执行事务</span><br>		List&lt;Object&gt; exec = multi.exec();<br>		<span class="hljs-comment">//判断事务提交是否失败</span><br>		<span class="hljs-keyword">if</span> (exec==<span class="hljs-literal">null</span> ||exec.size()==<span class="hljs-number">0</span>)&#123;<br>			System.out.println(<span class="hljs-string">&quot;秒杀结束了&quot;</span>);<br>			jedis.close();<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>		&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<p><strong>（3）但使用乐观锁会产生数据遗留问题。因为乐观锁，当数据修改时，会改变版本号，其他的用户不能秒杀，所以出现库存遗留</strong></p>
<p><strong>使用LUA脚本解决库存遗留问题</strong><br>（LUA：是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。）</p>
<p><strong>代码为：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">local userid=KEYS[<span class="hljs-number">1</span>];<br>local prodid=KEYS[<span class="hljs-number">2</span>];<br>local qtkey=<span class="hljs-string">&quot;sk:&quot;</span>..prodid..<span class="hljs-string">&quot;:qt&quot;</span>;<br>local usersKey=<span class="hljs-string">&quot;sk:&quot;</span>..prodid.<span class="hljs-string">&quot;:usr&#x27;;</span><br><span class="hljs-string">local userExists=redis.call(&quot;</span>sismember<span class="hljs-string">&quot;,usersKey,userid);</span><br><span class="hljs-string">if tonumber(userExists)==1 then</span><br><span class="hljs-string">return 2;</span><br><span class="hljs-string">end</span><br><span class="hljs-string">local num= redis.call(&quot;</span>get<span class="hljs-string">&quot; ,qtkey);</span><br><span class="hljs-string">if tonumber(num)&lt;=0 then</span><br><span class="hljs-string">return 0;</span><br><span class="hljs-string">else</span><br><span class="hljs-string">redis.call(&quot;</span>decr<span class="hljs-string">&quot;,qtkey);</span><br><span class="hljs-string">redis.call(&quot;</span>sadd<span class="hljs-string">&quot;,usersKey,userid);</span><br><span class="hljs-string">end</span><br><span class="hljs-string">return 1;</span><br></code></pre></td></tr></table></figure>

<h1 id="Redis-持久化之-RDB"><a href="#Redis-持久化之-RDB" class="headerlink" title="Redis 持久化之 RDB"></a>Redis 持久化之 RDB</h1><h2 id="为什么要持久化？"><a href="#为什么要持久化？" class="headerlink" title="为什么要持久化？"></a>为什么要持久化？</h2><p>为了能够重用Redis数据，或者防止系统故障，我们需要将Redis中的数据写入到磁盘中，即持久化。</p>
<p><strong>持久化：redis可以写到硬盘中。。</strong></p>
<blockquote>
<p>RDB是持久化方式，按照一定的时间间隔将内存的数据以快照的形式保存到硬盘，恢复时将快照读取到内存，</p>
</blockquote>
<h2 id="RDB是什么？"><a href="#RDB是什么？" class="headerlink" title="RDB是什么？"></a>RDB是什么？</h2><p>在<strong>指定的时间间隔</strong>内将内存中的<strong>数据集快照写入磁盘</strong>， 也就是行话讲的 Snapshot 快照，它恢复时是将快照文件直接读到内存里  </p>
<p><img src="/2022/06/07/redis/image-20220609193324763.png" srcset="/img/loading.gif" lazyload alt="image-20220609193324763"></p>
<h2 id="备份是如何进行的？"><a href="#备份是如何进行的？" class="headerlink" title="备份是如何进行的？"></a>备份是如何进行的？</h2><p>Redis 会单独创建（fork）一个子进程来进行持久化，会先将数据写入到 一个临时文件中，待持久化过程都结束了，再用这个临时文件替换上次持久化好的文件。 整个过程中，主进程是不进行任何 IO 操作的，  </p>
<p><img src="/2022/06/07/redis/image-20220609160158010.png" srcset="/img/loading.gif" lazyload alt="image-20220609160158010"></p>
<p><strong>Fork 的作用是复制一个与当前进程一样的进程。</strong>新进程的所有数据（变量、环境变量、程序计数器等） 数值都和原进程一致，但是是一个全新的进程，并作为原进程的子进程  </p>
<h2 id="RDB的优缺点"><a href="#RDB的优缺点" class="headerlink" title="RDB的优缺点"></a>RDB的优缺点</h2><p><strong>优点：</strong></p>
<ul>
<li>适合大规模的数据恢复  </li>
<li>对数据完整性和一致性要求不高更适合使用  </li>
<li>节省磁盘空间  </li>
<li>恢复速度快</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>Fork 的时候，内存中的数据被克隆了一份，大致 2 倍的膨胀性需要考虑  </li>
<li>虽然 Redis 在 fork 时使用了写时拷贝技术,但是如果数据庞大时还是比较消耗性能。  </li>
<li>备份周期在一定间隔时间做一次备份，所以如果 Redis 意外 down 掉的话，就会丢失最后一次快照后的所有修改</li>
</ul>
<h2 id="rbd的备份"><a href="#rbd的备份" class="headerlink" title="rbd的备份"></a>rbd的备份</h2><p>（1）先通过 config get dir 查询 rdb 文件的目录  </p>
<p>（2）将*.rdb 的文件拷贝到别的地方  eg:cp dump.rdb d.rdb</p>
<p>（3）rdb的恢复</p>
<ul>
<li><p>关闭 Redis  ，删除dump.rdb</p>
</li>
<li><p>先把备份的文件拷贝到工作目录下 cp d.rdb dump.rdb  </p>
</li>
<li><p>启动 Redis, 备份数据会直接加载  </p>
</li>
<li><p><img src="/2022/06/07/redis/image-20220609163844921.png" srcset="/img/loading.gif" lazyload alt="image-20220609163844921"></p>
<p><img src="/2022/06/07/redis/image-20220609163802517.png" srcset="/img/loading.gif" lazyload alt="image-20220609163802517"></p>
</li>
</ul>
<p><img src="/2022/06/07/redis/image-20220609163732378.png" srcset="/img/loading.gif" lazyload alt="image-20220609163732378"></p>
<h1 id="Redis-持久化之-AOF"><a href="#Redis-持久化之-AOF" class="headerlink" title="Redis 持久化之 AOF"></a>Redis 持久化之 AOF</h1><p>AOF 持久化以日志的形式记录服务器所处理的每一个写、删除操作，但查询操作不会记录，以文本的方式记录，可以打开文件看到详细的操作。</p>
<p>AOF采用文件追加方式，<strong>文件越来越大，为避免出现这种情况，新增了重写机制</strong>，当AOF文件的大小超过所设定的阈值，<strong>Redis就会启动AOF文件的内存压缩，只保留可以恢复数据的最小指令集。</strong></p>
<p><img src="/2022/06/07/redis/image-20220609193655926.png" srcset="/img/loading.gif" lazyload alt="image-20220609193655926"></p>
<h2 id="AOF-持久化流程"><a href="#AOF-持久化流程" class="headerlink" title="AOF 持久化流程"></a>AOF 持久化流程</h2><p>（1）客户端的请求写命令会被 append 追加到 AOF 缓冲区内；<br>（2）AOF 缓冲区根据 AOF 持久化策略[always,everysec,no]将操作 sync 同步到磁盘的AOF 文件中；<br>（3）AOF 文件大小超过重写策略或手动重写时，会对 AOF 文件 rewrite 重写，压缩AOF 文件容量；  </p>
<p>（4）Redis 服务重启时，会重新 load 加载 AOF 文件中的写操作达到数据恢复的目的；  </p>
<h2 id="AOF-启动-x2F-修复-x2F-恢复"><a href="#AOF-启动-x2F-修复-x2F-恢复" class="headerlink" title="AOF 启动&#x2F;修复&#x2F;恢复"></a>AOF 启动&#x2F;修复&#x2F;恢复</h2><ul>
<li><p>AOF 的备份机制和性能虽然和 RDB 不同, 但是备份和恢复的操作同 RDB 一样，都是拷贝备份文件，需要恢复时再拷贝到 Redis 工作目录下，启动系统即加载  </p>
</li>
<li><p>正常恢复  </p>
<ul>
<li>修改默认的 appendonly no，改为 yes  </li>
<li>将有数据的 aof 文件复制一份保存到对应目录(查看目录：config get dir)  </li>
<li>恢复：重启 redis 然后重新加载</li>
</ul>
</li>
<li><p>异常恢复  </p>
<ul>
<li>修改默认的 appendonly no，改为 yes  </li>
<li>如遇到 AOF 文件损坏，通过&#x2F;usr&#x2F;local&#x2F;bin&#x2F;redis-check-aof–fix appendonly.aof 进行恢复  </li>
<li>备份被写坏的 AOF 文件  </li>
<li>恢复：重启 redis，然后重新加载</li>
</ul>
</li>
</ul>
<h2 id="AOF的优缺点"><a href="#AOF的优缺点" class="headerlink" title="AOF的优缺点"></a>AOF的优缺点</h2><p><strong>优势</strong>  </p>
<ul>
<li>备份机制更稳健，丢失数据概率更低  </li>
<li>可读的日志文本，通过操作 AOF 稳健，可以处理误操作。</li>
</ul>
<p><strong>劣势</strong>  </p>
<ul>
<li>比起 RDB 占用更多的磁盘空间。  </li>
<li>恢复备份速度要慢。  </li>
<li>每次读写都同步的话，有一定的性能压力  </li>
<li>存在个别 Bug，造成恢复不能。</li>
</ul>
<h1 id="对于持久化方式官网的建议"><a href="#对于持久化方式官网的建议" class="headerlink" title="对于持久化方式官网的建议"></a>对于持久化方式官网的建议</h1><ul>
<li>官方推荐两个都启用。</li>
<li>如果对数据不敏感，可以选单独用 RDB。</li>
<li>不建议单独用 AOF，因为可能会出现 Bug。</li>
<li>如果只是做纯内存缓存，可以都不用。</li>
</ul>
<h1 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h1><p>主机数据更新后根据配置和策略， 自动同步到备机的 master&#x2F;slaver 机制，<strong>Master 以写为主，Slave 以读为主</strong>  </p>
<h2 id="能干嘛"><a href="#能干嘛" class="headerlink" title="能干嘛"></a>能干嘛</h2><ul>
<li>读写分离，性能扩展  </li>
<li>容灾快速恢复  （当一台从机挂掉之后，其他从机能快速提供服务  ）</li>
<li><img src="/2022/06/07/redis/image-20220610102855173.png" srcset="/img/loading.gif" lazyload alt="image-20220610102855173"></li>
</ul>
<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><p><img src="/2022/06/07/redis/image-20220610102915397.png" srcset="/img/loading.gif" lazyload alt="image-20220610102915397"></p>
<p><img src="/2022/06/07/redis/image-20220610104030188.png" srcset="/img/loading.gif" lazyload alt="image-20220610104030188"></p>
<p>info replication<br><strong>打印主从复制的相关信息</strong></p>
<p><img src="/2022/06/07/redis/image-20220610111351081.png" srcset="/img/loading.gif" lazyload alt="image-20220610111351081"></p>
<p><strong>配从(库)不配主(库)</strong>  </p>
<p><code>slaveof &lt;ip&gt;&lt;port&gt;</code>  ：主服务器的ip和端口。</p>
<p><strong>在主机上写，在从机上可以读取数据</strong>  </p>
<p><strong>主机挂掉，重启就行，一切如初</strong>  </p>
<p><strong>从机重启需重设：slaveof 127.0.0.1 6379</strong>  </p>
<h2 id="一主二仆"><a href="#一主二仆" class="headerlink" title="一主二仆"></a>一主二仆</h2><p>从机不可以写数据，</p>
<p>主机shutdown后，从机还是原地待命，不会上位变为主机。</p>
<p>主机又回来之后，主机新增记录，从机还能顺利复制，</p>
<p>其中一台从机down后，从新开启，重设<code>slaveof 127.0.0.1 6379</code>  ，依旧可以复制主机中的全部数据，。</p>
<h2 id="薪火相传"><a href="#薪火相传" class="headerlink" title="薪火相传"></a>薪火相传</h2><p>其中一个从机可以作为其他其他从机的主机，。同样可以接受其他从机的连接和请求，可以有效减轻master’写的压力。<strong>也就是一态主机只写到一台从机，而一台从机下面右好多从机（缺点就是，唯一的这台与主机交互的从机一旦down掉，则后面的那些从机都没办法复制）</strong></p>
<p>**用 <code>slaveof &lt;ip&gt;&lt;port&gt;**</code>  </p>
<p><strong>中途变更转向:会清除之前的数据，重新建立拷贝最新的</strong>  </p>
<p><strong>风险是一旦某个 slave 宕机，后面的 slave 都没法备份</strong>  </p>
<p><strong>主机挂了，从机还是从机，无法写数据了</strong>  </p>
<p><img src="/2022/06/07/redis/image-20220610113123157.png" srcset="/img/loading.gif" lazyload alt="image-20220610113123157"></p>
<h2 id="反客为主"><a href="#反客为主" class="headerlink" title="反客为主"></a>反客为主</h2><p><strong>当一个 master 宕机后，后面的 slave 可以立刻升为 master，其后面的 slave 不用做任何修改。</strong></p>
<p>  <strong>用 <code>slaveof no one</code> 将从机变为主机。</strong>  </p>
<p><strong>但这个过程是手动设置的，但在真正的使用中，如果主机挂掉，工作人员需要时间去指定下一个上位的从机，但这会花费时间，有没有一种可以自动去执行的这个过程？</strong></p>
<p><strong>搭：哨兵模式。在下面</strong></p>
<h2 id="复制原理"><a href="#复制原理" class="headerlink" title="复制原理"></a><strong>复制原理</strong></h2><ul>
<li>Slave 启动成功连接到 master 后会发送一个 sync（内存中的数据写入磁盘中） 命令</li>
<li>Master 接到命令启动后台的存盘进程，同时收集所有接收到的用于修改数据集命令， 在后台进程执行完毕之后，master 将传送整个数据文件到 slave,以完成一次完全同步</li>
<li>全量复制：而 slave 服务在接收到数据库文件数据后，将其存盘并加载到内存中。</li>
<li>增量复制：Master 继续将新的所有收集到的修改命令依次传给 slave,完成同步</li>
<li>但是只要是重新连接 master,一次完全同步（全量复制)将被自动执行</li>
</ul>
<p><img src="/2022/06/07/redis/image-20220610111839270.png" srcset="/img/loading.gif" lazyload alt="image-20220610111839270"></p>
<h2 id="哨兵模式-sentinel"><a href="#哨兵模式-sentinel" class="headerlink" title="哨兵模式(sentinel)"></a>哨兵模式(sentinel)</h2><p>是什么：</p>
<p><strong>反客为主的自动版</strong>，能够后台监控主机是否故障，如果故障了<strong>根据投票数自动将从库转换为主库</strong>  </p>
<p><img src="/2022/06/07/redis/image-20220610115550445.png" srcset="/img/loading.gif" lazyload alt="image-20220610115550445"></p>
<p><strong>步骤：</strong></p>
<p>（1）调整为一主二仆模式， 6379 带着 6380、 6381  </p>
<p>（2）自定义的&#x2F;myredis 目录下新建 sentinel.conf 文件， 名字绝不能错  </p>
<p>（3）配置哨兵,填写内容  ：<code>sentinel monitor mymaster 127.0.0.1 6379 1</code>  （其中 mymaster 为监控对象起的服务器名称， 1 为至少有多少个哨兵同意迁移的数量。  ）</p>
<p>（4）启动哨兵  ：执行 <code>redis-sentinel /myredis/sentinel.conf</code>  </p>
<p><img src="/2022/06/07/redis/image-20220610115726460.png" srcset="/img/loading.gif" lazyload alt="image-20220610115726460"></p>
<p><strong>当主机挂掉， 从机选举中产生新的主机</strong>  </p>
<p>应该选择哪个从机作为主机呢？</p>
<p>（1）<strong>选择优先级靠前的。</strong>—redis.conf配置文件中，<code>replica-priority</code>  默认值为100，值越小优先级越高</p>
<p>（2）<strong>选择偏移量最大的</strong>，也就是从机中包含主机中数据最多的。</p>
<p>（3）<strong>选择runid最小的从服务：</strong>：每个 redis 实例启动后都会随机生成一个 40 位的 runid  （这个就是随机选取了）</p>
<p><strong>主从复制设置哨兵的工具类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> JedisSentinelPool jedisSentinelPool=<span class="hljs-literal">null</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Jedis <span class="hljs-title function_">getJedisFromSentinel</span><span class="hljs-params">()</span>&#123;<br>	<span class="hljs-keyword">if</span>(jedisSentinelPool==<span class="hljs-literal">null</span>)&#123;<br>		Set&lt;String&gt; sentinelSet=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br>		sentinelSet.add(<span class="hljs-string">&quot;192.168.11.103:26379&quot;</span>);<br>		<span class="hljs-type">JedisPoolConfig</span> <span class="hljs-variable">jedisPoolConfig</span> <span class="hljs-operator">=</span><span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPoolConfig</span>();<br>		jedisPoolConfig.setMaxTotal(<span class="hljs-number">10</span>); <span class="hljs-comment">//最大可用连接数</span><br>		jedisPoolConfig.setMaxIdle(<span class="hljs-number">5</span>); <span class="hljs-comment">//最大闲置连接数</span><br>		jedisPoolConfig.setMinIdle(<span class="hljs-number">5</span>); <span class="hljs-comment">//最小闲置连接数</span><br>		jedisPoolConfig.setBlockWhenExhausted(<span class="hljs-literal">true</span>); <span class="hljs-comment">//连接耗尽是否等待</span><br>		jedisPoolConfig.setMaxWaitMillis(<span class="hljs-number">2000</span>); <span class="hljs-comment">//等待时间</span><br>		jedisPoolConfig.setTestOnBorrow(<span class="hljs-literal">true</span>); <span class="hljs-comment">//取连接的时候进行一下测试 ping pong</span><br>		jedisSentinelPool=<span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisSentinelPool</span>(<span class="hljs-string">&quot;mymaster&quot;</span>,sentinelSet,jedisPoolConfig);<br>		<span class="hljs-keyword">return</span> jedisSentinelPool.getResource();<br>		replica-priority&#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>		<span class="hljs-keyword">return</span> jedisSentinelPool.getResource();<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="Redis-集群"><a href="#Redis-集群" class="headerlink" title="Redis 集群"></a>Redis 集群</h1><p>容量不够，redis 如何进行扩容？  可以使用多台redis</p>
<p>并发写操作， redis 如何分摊？   多个redis</p>
<p><strong>之前通过代理主机来解决，但是 redis3.0 中提供了解决方案。就是无中心化集群配置。</strong>  </p>
<p><strong>之前的代理主机：</strong></p>
<p><img src="/2022/06/07/redis/image-20220610121734297.png" srcset="/img/loading.gif" lazyload alt="image-20220610121734297"></p>
<p><strong>现在的无中心化集群配置：</strong></p>
<p><strong>任何一台服务器都可以作为集群的入口。</strong>可以把请求转交给任何一台服务器</p>
<p><img src="/2022/06/07/redis/image-20220610121748075.png" srcset="/img/loading.gif" lazyload alt="image-20220610121748075"></p>
<h2 id="什么是集群"><a href="#什么是集群" class="headerlink" title="什么是集群"></a>什么是集群</h2><p><strong>Redis 集群实现了对 Redis 的水平扩容</strong>，即启动 N 个 redis 节点，将整个数据库分布存储在这 N 个节点中，每个节点存储总数据的 1&#x2F;N  </p>
<p><strong>Redis 集群通过分区（partition）来提供一定程度的可用性（availability）</strong>： 即使集群中有一部分节点失效或者无法进行通讯， 集群也可以继续处理命令请求。  （提供了从机）</p>
<h2 id="配置集群步骤："><a href="#配置集群步骤：" class="headerlink" title="配置集群步骤："></a><strong>配置集群步骤：</strong></h2><p>（1）将 rdb,aof 文件都删除掉  </p>
<p>（2）制作 6 个实例， 6379,6380,6381,6389,6390,6391.conf</p>
<p>（3）redis cluster 配置修改  ，在原来的主从复制中的配置添加：</p>
<ul>
<li>cluster-enabled yes 打开集群模式</li>
<li>cluster-config-file nodes-6379.conf 设定节点配置文件名</li>
<li>cluster-node-timeout 15000 设定节点失联时间，超过该时间（毫秒），集群自动进行主从切换。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">include /home/bigdata/redis.conf<br>port <span class="hljs-number">6379</span><br>pidfile <span class="hljs-string">&quot;/var/run/redis_6379.pid&quot;</span><br>dbfilename <span class="hljs-string">&quot;dump6379.rdb&quot;</span><br>dir <span class="hljs-string">&quot;/home/bigdata/redis_cluster&quot;</span><br>logfile <span class="hljs-string">&quot;/home/bigdata/redis_cluster/redis_err_6379.log&quot;</span><br>cluster-enabled yes<br>cluster-config-file nodes-<span class="hljs-number">6379.</span>conf<br>cluster-node-timeout <span class="hljs-number">15000</span><br></code></pre></td></tr></table></figure>

<p>（4）修 改 好 redis6379.conf 文 件 ， 拷 贝 多 个redis.conf 文件  ，分别对应（ 6379,6380,6381,6389,6390,6391.conf）</p>
<p>（5）使用查找替换修改另外 5 个文件  ：<code>%s/6379/6380</code>  </p>
<p>（6）启动 6 个 redis 服务  </p>
<p>（7）将六个节点合成一个集群  ：组合之前，请确保所有 redis 实例启动后，nodes-xxxx.conf 文件都生成正常  </p>
<ul>
<li>合体： <code>cd /opt/redis-6.2.1/src</code>  redis文件的位置中的src</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">redis</span>-cli --cluster create --cluster-replicas <span class="hljs-number">1</span> <span class="hljs-number">192.168.11.101:6379</span><br><span class="hljs-attribute">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">11</span>.<span class="hljs-number">101</span>:<span class="hljs-number">6380</span> <span class="hljs-number">192.168.11.101:6381</span> <span class="hljs-number">192.168.11.101:6389</span><br><span class="hljs-attribute">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">11</span>.<span class="hljs-number">101</span>:<span class="hljs-number">6390</span> <span class="hljs-number">192.168.11.101:6391</span><br></code></pre></td></tr></table></figure>

<p><strong>此处不要用 127.0.0.1， 请用真实 IP 地址</strong><br><strong>–replicas 1 :采用最简单的方式配置集群，一台主机，一台从机，正好三组。</strong>  </p>
<p>（8）采用集群的方式连接</p>
<p><img src="/2022/06/07/redis/image-20220610124129675.png" srcset="/img/loading.gif" lazyload alt="image-20220610124129675"></p>
<p>（9）通过 <code>cluster nodes</code> 命令查看集群信息  </p>
<p><strong>redis cluster 如何分配这六个节点?</strong>  </p>
<p>（1）一个集群至少要有三个主节点  </p>
<p>（2）选项 –cluster-replicas 1 表示我们希望为集群中的每个主节点创建一个从节点  </p>
<p>（3）分配原则尽量保证每个主数据库运行在不同的 IP 地址，每个从库和主库不在一个 IP 地址上。  （因为当一台主机挂掉之后，从机可以变为主机，如果都在一台服务器上时，则从机也挂掉了）</p>
<h2 id="什么是-slots"><a href="#什么是-slots" class="headerlink" title="什么是 slots"></a>什么是 slots</h2><p>一个 Redis 集群包含 16384 个插槽（hash slot）（为了集群平均分配）， 数据库中的每个键都属于这 16384个插槽的其中一个  </p>
<p><img src="/2022/06/07/redis/image-20220610131018008.png" srcset="/img/loading.gif" lazyload alt="image-20220610131018008"></p>
<p><strong>集群使用公式 CRC16(key) % 16384 来计算键 key 属于哪个槽， 其中 CRC16(key) 语句用于计算键 key 的 CRC16 校验和 。</strong>  </p>
<p><strong>集群中的每个节点负责处理一部分插槽</strong>  </p>
<p><strong>在集群中录入值：</strong>自动分配到键所对应的插槽中，</p>
<p><img src="/2022/06/07/redis/image-20220610130004189.png" srcset="/img/loading.gif" lazyload alt="image-20220610130004189"></p>
<p><strong>不能进行 <code>mget</code> 和 mset 操作，可以通过{}来定义组的概念，从而使 key 中{}内相同内容的键值对放到一个 slot 中去。</strong>  </p>
<p><img src="/2022/06/07/redis/image-20220610130140398.png" srcset="/img/loading.gif" lazyload alt="image-20220610130140398"></p>
<p><strong>查询集群中的值  （计算插槽值）：</strong></p>
<p><img src="/2022/06/07/redis/image-20220610130257347.png" srcset="/img/loading.gif" lazyload alt="image-20220610130257347"></p>
<p><code>CLUSTER GETKEYSINSLOT &lt;slot&gt;&lt;count&gt;</code> <strong>返回 count 个 slot 槽中的键。</strong>  </p>
<h2 id="故障恢复"><a href="#故障恢复" class="headerlink" title="故障恢复"></a>故障恢复</h2><p><strong>如果主节点下线，则从节点自动上位为主节点，</strong></p>
<p><strong>当主节点恢复回来后，变为从节点，</strong></p>
<p><strong>如果所有某一段插槽的主从节点都宕掉，redis 服务是否还能继续?</strong>  </p>
<ul>
<li>如果某一段插槽的主从都挂掉，而<strong>redis.conf中的</strong> <strong>cluster-require-full-coverage 为 yes</strong> ，那么 ，<strong>整个集群都挂掉</strong></li>
<li>如果某一段插槽的主从都挂掉，而 <strong>redis.conf中的cluster-require-full-coverage 为 no</strong> ，那么，该插槽数据全都不能使用，也无法存储。<strong>但其他插槽还可以继续使用</strong></li>
</ul>
<h2 id="集群的-Jedis-开发"><a href="#集群的-Jedis-开发" class="headerlink" title="集群的 Jedis 开发"></a>集群的 Jedis 开发</h2><p><img src="/2022/06/07/redis/image-20220610132151742.png" srcset="/img/loading.gif" lazyload alt="image-20220610132151742"></p>
<h2 id="Redis集群的好处和不足"><a href="#Redis集群的好处和不足" class="headerlink" title="Redis集群的好处和不足"></a>Redis集群的好处和不足</h2><p><strong>好处：</strong></p>
<ul>
<li>实现扩容  （用集群实现扩容  ）</li>
<li>分摊压力  （用多台机器分担某一台机器（插槽）  ）</li>
<li>无中心配置相对简单  （任何一个节点都能进入到集群，之间能够互相切换  ）</li>
</ul>
<p><strong>不足”：</strong></p>
<ul>
<li>多键操作是不被支持的  </li>
<li>多键的 Redis 事务是不被支持的。lua 脚本不被支持  </li>
<li>由于集群方案出现较晚，很多公司已经采用了其他的集群方案，而代理或者客户端分片的方案想要迁移至 redis cluster，需要整体迁移而不是逐步过渡，复杂度较大。</li>
</ul>
<h1 id="Redis应用问题的解决"><a href="#Redis应用问题的解决" class="headerlink" title="Redis应用问题的解决"></a>Redis应用问题的解决</h1><h2 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h2><p><strong>问题描述</strong></p>
<p>key 对应的数据在数据源并不存在，<strong>每次针对此 key 的请求从缓存获取不到，请求都会压到数据源，从而可能压垮数据源。</strong>比如用一个不存在的用户 id 获取用户信息，不论缓存还是数据库都没有，若黑客利用此漏洞进行攻击可能压垮数据库  </p>
<p><img src="/2022/06/07/redis/image-20220610143457717.png" srcset="/img/loading.gif" lazyload alt="image-20220610143457717"></p>
<p><strong>解决方案</strong></p>
<p>最终解决的方式就是，不安全的连接不能进入数据库，拦到外面</p>
<p>（1）<strong>对空值缓存</strong>：如果一个查询返回的数据为空（不管是数据是否不存在），我们仍然把这个空结果（null）进行缓存，设置空结果的过期时间会很短，最长不超过五分钟  .</p>
<p>（2）<strong>设置可访问的名单（白名单）  ：</strong>使用 bitmaps 类型定义一个可以访问的名单，名单 id 作为 bitmaps 的偏移量，每次访问和 bitmap 里面的 id 进行比较，如果访问 id 不在 bitmaps 里面，进行拦截，不允许访问。  </p>
<p>（3）<strong>采用布隆过滤器</strong>  ：将所有可能存在的数据哈希到一个足够大的 bitmaps 中，一个一定不存在的数据会被 这个 bitmaps 拦截掉，从而避免了对底层存储系统的查询压力。  </p>
<p>（4）<strong>进行实时监控</strong>：当发现 Redis 的命中率开始急速降低，需要排查访问对象和访问的数据，和运维人员配合，可以设置黑名单限制服务  </p>
<h2 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h2><p>key 对应的数据存在，但在 redis 中过期，此时若有大量并发请求过来，这些请求发现缓存过期一般都会从后端 DB 加载数据并回设到缓存，这个时候大并发的请求可能会瞬间把后端 DB 压垮 。</p>
<p><img src="/2022/06/07/redis/image-20220610144458611.png" srcset="/img/loading.gif" lazyload alt="image-20220610144458611"></p>
<p><strong>解决方案：</strong></p>
<p>（1）<strong>预先设置热门数据</strong>：在 redis 高峰访问之前，把一些热门数据提前存入到redis 里面，加大这些热门数据 key 的时长<br>（2）<strong>实时调整</strong>：现场监控哪些数据热门，实时调整 key 的过期时长<br>（3）<strong>使用锁：</strong>（效率低）</p>
<ul>
<li>就是在缓存失效的时候（判断拿出来的值为空），不是立即去 load db。</li>
<li>先使用缓存工具的某些带成功操作返回值的操作（比如 Redis 的 SETNX）去 set 一个 mutex key  </li>
<li>当操作返回成功时，再进行 load db 的操作，并回设缓存,最后删除 mutexkey；  </li>
<li>当操作返回失败，证明有线程在 load db，当前线程睡眠一段时间再重试整个 get 缓存的方法  </li>
<li><img src="/2022/06/07/redis/image-20220610144742863.png" srcset="/img/loading.gif" lazyload alt="image-20220610144742863"></li>
</ul>
<h2 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h2><p>key 对应的数据存在，但在 redis 中过期，此时若有大量并发请求过来，这些请求发现缓存过期一般都会从后端 DB 加载数据并回设到缓存，这个时候大并发的请求可能会瞬间把后端 DB 压垮。<br><strong>缓存雪崩与缓存击穿的区别在于这里针对很多 key 缓存，前者则是某一个 key</strong>  </p>
<p><img src="/2022/06/07/redis/image-20220610145205724.png" srcset="/img/loading.gif" lazyload alt="image-20220610145205724"></p>
<p><strong>解决方案：“</strong></p>
<p>（1） <strong>构建多级缓存架构：</strong>nginx 缓存 + redis 缓存 +其他缓存（ehcache 等）<br>（2） <strong>使用锁或队列</strong>：用加锁或者队列的方式保证来保证不会有大量的线程对数据库一次性进行读写，从而避免失效时大量的并发请求落到底层存储系统上。不适用高并发情况<br>（3） <strong>设置过期标志更新缓存</strong>：记录缓存数据是否过期（设置提前量），如果过期会触发通知另外的线程在后台去更新实际 key 的缓存。<br>（4） <strong>将缓存失效时间分散开</strong>：比如我们可以在原有的失效时间基础上增加一个随机值，比如 1-5 分钟随机，这样每一个缓存的过期时间的重复率就会降低，就很难引发集体失效的事件。  </p>
<h2 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h2><p>原单体单机部署的系统被演化成分布式集群系统后，由于分布式系统多线程、多进程并且分布在不同机器上，这将使原单机部署情况下的并发控制锁策略失效，单纯的 Java API 并不能提供分布式锁的能力。为了解决这个问题就需要一种跨 JVM 的互斥机制来控制共享资源的访问，这就是分布式锁要解决的问题！  </p>
<p><img src="/2022/06/07/redis/image-20220610150150521.png" srcset="/img/loading.gif" lazyload alt="image-20220610150150521"></p>
<p><img src="/2022/06/07/redis/image-20220610150026377.png" srcset="/img/loading.gif" lazyload alt="image-20220610150026377"></p>
<p><strong>编写代码：</strong></p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">@<span class="hljs-constructor">GetMapping(<span class="hljs-string">&quot;testLock&quot;</span>)</span><br>public void test<span class="hljs-constructor">Lock()</span>&#123;<br>	<span class="hljs-comment">//1 获取锁， setne</span><br>	Boolean lock = redisTemplate.ops<span class="hljs-constructor">ForValue()</span>.set<span class="hljs-constructor">IfAbsent(<span class="hljs-string">&quot;lock&quot;</span>, <span class="hljs-string">&quot;111&quot;</span>)</span>;<br>	<span class="hljs-comment">//2 获取锁成功、 查询 num 的值if(lock)&#123;</span><br>	Object value = redisTemplate.ops<span class="hljs-constructor">ForValue()</span>.get(<span class="hljs-string">&quot;num&quot;</span>);<br>	<span class="hljs-comment">//2.1 判断 num 为空 return</span><br>	<span class="hljs-keyword">if</span>(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">StringUtils</span>.</span></span>is<span class="hljs-constructor">Empty(<span class="hljs-params">value</span>)</span>)&#123;<br>		return;<br>	&#125; <br>	<span class="hljs-comment">//2.2 有值就转成成 int</span><br>	<span class="hljs-built_in">int</span> num = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Integer</span>.</span></span>parse<span class="hljs-constructor">Int(<span class="hljs-params">value</span>+<span class="hljs-string">&quot;&quot;</span>)</span>;<br>	<span class="hljs-comment">//2.3 把 redis 的 num 加 1</span><br>	redisTemplate.ops<span class="hljs-constructor">ForValue()</span>.set(<span class="hljs-string">&quot;num&quot;</span>, ++num);<br>	<span class="hljs-comment">//2.4 释放锁， del</span><br>	redisTemplate.delete(<span class="hljs-string">&quot;lock&quot;</span>);<br>	&#125;<span class="hljs-keyword">else</span>&#123;<br>		<span class="hljs-comment">//3 获取锁失败、 每隔 0.1 秒再获取</span><br>	<span class="hljs-keyword">try</span> &#123;<br>		<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Thread</span>.</span></span>sleep(<span class="hljs-number">100</span>);<br>		test<span class="hljs-constructor">Lock()</span>;<br>	&#125; catch (InterruptedException e) &#123;<br>		e.print<span class="hljs-constructor">StackTrace()</span>;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>问题1：</strong> setnx 刚好获取到锁， 业务逻辑出现异常， 导致锁无法释放<br><strong>解决：</strong> 设置过期时间， 自动释放锁  </p>
<p>**优化之设置锁的过期时间  **</p>
<p>两种方式：</p>
<p>（1）首先想到通过 expire 设置过期时间（缺乏原子性： 如果在 setnx 和 expire 之<br>间出现异常， 锁也无法释放）<br>（2） 在 set 时指定过期时间（推荐）  </p>
<p><img src="/2022/06/07/redis/image-20220610152715911.png" srcset="/img/loading.gif" lazyload alt="image-20220610152715911"></p>
<p><strong>问题2： 可能会释放其他服务器的锁。</strong>  </p>
<p><strong>场景：</strong></p>
<p><img src="/2022/06/07/redis/image-20220610152828761.png" srcset="/img/loading.gif" lazyload alt="image-20220610152828761"></p>
<p><strong>代码：</strong></p>
<p><img src="/2022/06/07/redis/image-20220610152957380.png" srcset="/img/loading.gif" lazyload alt="image-20220610152957380"></p>
<p><img src="/2022/06/07/redis/image-20220610153011261.png" srcset="/img/loading.gif" lazyload alt="image-20220610153011261"></p>
<p><strong>但是使用了UUID之后不具有原子性：</strong></p>
<p><img src="/2022/06/07/redis/image-20220610153713549.png" srcset="/img/loading.gif" lazyload alt="image-20220610153713549"></p>
<p><strong>使用LUA脚本保证删除的原子性</strong>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;testLockLua&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testLockLua</span><span class="hljs-params">()</span> &#123;<br>	<span class="hljs-comment">//1 声明一个 uuid ,将做为一个 value 放入我们的 key 所对应的值中</span><br>	<span class="hljs-type">String</span> <span class="hljs-variable">uuid</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();<br>	<span class="hljs-comment">//2 定义一个锁： lua 脚本可以使用同一把锁， 来实现删除！</span><br>	<span class="hljs-type">String</span> <span class="hljs-variable">skuId</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;25&quot;</span>; <span class="hljs-comment">// 访问 skuId 为 25 号的商品 100008348542</span><br>	<span class="hljs-type">String</span> <span class="hljs-variable">locKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lock:&quot;</span> + skuId; <span class="hljs-comment">// 锁住的是每个商品的数据// 3 获取锁</span><br>	<span class="hljs-type">Boolean</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().setIfAbsent(locKey, uuid, <span class="hljs-number">3</span>,<br>	TimeUnit.SECONDS);<br>	<span class="hljs-comment">// 第一种： lock 与过期时间中间不写任何的代码。</span><br>	<span class="hljs-comment">// redisTemplate.expire(&quot;lock&quot;,10, TimeUnit.SECONDS);//设置过期时间</span><br>	<span class="hljs-comment">// 如果 true</span><br>	<span class="hljs-keyword">if</span> (lock) &#123;<br>		<span class="hljs-comment">// 执行的业务逻辑开始</span><br>		<span class="hljs-comment">// 获取缓存中的 num 数据</span><br>		<span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(<span class="hljs-string">&quot;num&quot;</span>);<br>		<span class="hljs-comment">// 如果是空直接返回</span><br>		<span class="hljs-keyword">if</span> (StringUtils.isEmpty(value)) &#123;<br>			<span class="hljs-keyword">return</span>;<br>		&#125; <br>		<span class="hljs-comment">// 不是空 如果说在这出现了异常！ 那么 delete 就删除失败！ 也就是说锁永远存在！</span><br>		<span class="hljs-type">int</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> Integer.parseInt(value + <span class="hljs-string">&quot;&quot;</span>);<br>		<span class="hljs-comment">// 使 num 每次+1 放入缓存</span><br>		redisTemplate.opsForValue().set(<span class="hljs-string">&quot;num&quot;</span>, String.valueOf(++num));<br>		<span class="hljs-comment">/*使用 lua 脚本来锁*/</span><br>		<span class="hljs-comment">// 定义 lua 脚本</span><br>		<span class="hljs-type">String</span> <span class="hljs-variable">script</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;if redis.call(&#x27;get&#x27;, KEYS[1]) == ARGV[1] then return</span><br><span class="hljs-string">		redis.call(&#x27;del&#x27;, KEYS[1]) else return 0 end&quot;</span>;<br>		<span class="hljs-comment">// 使用 redis 执行 lua 执行</span><br>		DefaultRedisScript&lt;Long&gt; redisScript = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;();<br>		redisScript.setScriptText(script);<br>		<span class="hljs-comment">// 设置一下返回值类型 为 Long</span><br>		<span class="hljs-comment">// 因为删除判断的时候， 返回的 0,给其封装为数据类型。 如果不封装那么默认返回 String 类型，</span><br>		<span class="hljs-comment">// 那么返回字符串与 0 会有发生错误。</span><br>		redisScript.setResultType(Long.class);<br>		<span class="hljs-comment">// 第一个要是 script 脚本 ， 第二个需要判断的 key， 第三个就是 key 所对应的值。</span><br>		redisTemplate.execute(redisScript, Arrays.asList(locKey), uuid);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-comment">// 其他线程等待</span><br>		<span class="hljs-keyword">try</span> &#123;<br>		<span class="hljs-comment">// 睡眠</span><br>		Thread.sleep(<span class="hljs-number">1000</span>);<br>		<span class="hljs-comment">// 睡醒了之后， 调用方法。</span><br>		testLockLua();<br>		&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>			e.printStackTrace();<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>LUA脚本详解</strong></p>
<p><img src="/2022/06/07/redis/image-20220610154032749.png" srcset="/img/loading.gif" lazyload alt="image-20220610154032749"></p>
<p><img src="/2022/06/07/redis/image-20220610154103532.png" srcset="/img/loading.gif" lazyload alt="image-20220610154103532"></p>

              
            </div>
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Redis/" class="category-chain-item">Redis</a>
  
  
    <span>></span>
    
  <a href="/categories/Redis/%E5%9F%BA%E7%A1%80/" class="category-chain-item">基础</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/redis/">#redis</a>
      
        <a href="/tags/NoSQL/">#NoSQL</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>redis</div>
      <div>http://example.com/2022/06/07/redis/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>zlw</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年6月7日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/06/07/%E7%9B%B8%E4%BA%A4%E9%93%BE%E8%A1%A8/" title="相交链表">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">相交链表</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/06/06/%E6%9C%80%E5%B0%8F%E6%A0%88/" title="最小栈">
                        <span class="hidden-mobile">最小栈</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.16/Valine.min.js', function() {
        var options = Object.assign(
          {"enable":true,"appId":"8pDDCsRJCVNm1OXHuh0xASVj-gzGzoHsz","appKey":"MnpSoeG5QTTJ4GagUMOq5t7J","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"https://8pddcsrj.lc-cn-n1-shared.com","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       #<a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> #<i class="iconfont icon-love"></i> #<a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> #<a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> #<i class="iconfont icon-love"></i> #<a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div>张露文的博客 | 记录成长过程</div> <div style="font-size: 0.85rem"> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  

  

  

  

  

  

  
    
  




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script>
  (function() {
    var enableLang = CONFIG.code_language.enable && CONFIG.code_language.default;
    var enableCopy = CONFIG.copy_btn;
    if (!enableLang && !enableCopy) {
      return;
    }

    function getBgClass(ele) {
      return Fluid.utils.getBackgroundLightness(ele) >= 0 ? 'code-widget-light' : 'code-widget-dark';
    }

    var copyTmpl = '';
    copyTmpl += '<div class="code-widget">';
    copyTmpl += 'LANG';
    copyTmpl += '</div>';
    jQuery('.markdown-body pre').each(function() {
      var $pre = jQuery(this);
      if ($pre.find('code.mermaid').length > 0) {
        return;
      }
      if ($pre.find('span.line').length > 0) {
        return;
      }

      var lang = '';

      if (enableLang) {
        lang = CONFIG.code_language.default;
        if ($pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2 && $pre.children().hasClass('hljs')) {
          lang = $pre[0].children[0].classList[1];
        } else if ($pre[0].getAttribute('data-language')) {
          lang = $pre[0].getAttribute('data-language');
        } else if ($pre.parent().hasClass('sourceCode') && $pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2) {
          lang = $pre[0].children[0].classList[1];
          $pre.parent().addClass('code-wrapper');
        } else if ($pre.parent().hasClass('markdown-body') && $pre[0].classList.length === 0) {
          $pre.wrap('<div class="code-wrapper"></div>');
        }
        lang = lang.toUpperCase().replace('NONE', CONFIG.code_language.default);
      }
      $pre.append(copyTmpl.replace('LANG', lang).replace('code-widget">',
        getBgClass($pre[0]) + (enableCopy ? ' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>' : ' code-widget">')));

      if (enableCopy) {
        Fluid.utils.createScript('https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js', function() {
          var clipboard = new window.ClipboardJS('.copy-btn', {
            target: function(trigger) {
              var nodes = trigger.parentNode.childNodes;
              for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].tagName === 'CODE') {
                  return nodes[i];
                }
              }
            }
          });
          clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-copy', 'icon-success');
            setTimeout(function() {
              e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-success', 'icon-copy');
            }, 2000);
          });
        });
      }
    });
  })();
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="/js/leancloud.js" ></script>




  
<script src="/js/diy/timeDate.js"></script>
<script src="//cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
<script src="//cdn.jsdelivr.net/gh/metowolf/Metingjs@1.2/dist/Meting.min.js"></script>
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/qipao.js"></script>
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/dianjichuzi.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
